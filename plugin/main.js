/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var bo=Object.create;var Re=Object.defineProperty;var xo=Object.getOwnPropertyDescriptor;var So=Object.getOwnPropertyNames;var ko=Object.getPrototypeOf,Uo=Object.prototype.hasOwnProperty;var _o=(n,t)=>{for(var e in t)Re(n,e,{get:t[e],enumerable:!0})},Xr=(n,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of So(t))!Uo.call(n,s)&&s!==e&&Re(n,s,{get:()=>t[s],enumerable:!(r=xo(t,s))||r.enumerable});return n};var kt=(n,t,e)=>(e=n!=null?bo(ko(n)):{},Xr(t||!n||!n.__esModule?Re(e,"default",{value:n,enumerable:!0}):e,n)),Eo=n=>Xr(Re({},"__esModule",{value:!0}),n);var jl={};_o(jl,{default:()=>Rn});module.exports=Eo(jl);var yo=require("obsidian");var Qr={serverUrl:"ws://localhost:1234",username:"Anonymous",enabled:!1};var T=()=>new Map,Fe=n=>{let t=T();return n.forEach((e,r)=>{t.set(r,e)}),t},F=(n,t,e)=>{let r=n.get(t);return r===void 0&&n.set(t,r=e()),r},Zr=(n,t)=>{let e=[];for(let[r,s]of n)e.push(t(s,r));return e},ts=(n,t)=>{for(let[e,r]of n)if(t(r,e))return!0;return!1};var H=()=>new Set;var je=n=>n[n.length-1];var es=(n,t)=>{for(let e=0;e<t.length;e++)n.push(t[e])},J=Array.from;var ns=(n,t)=>{for(let e=0;e<n.length;e++)if(t(n[e],e,n))return!0;return!1};var fe=Array.isArray;var Ut=class{constructor(){this._observers=T()}on(t,e){return F(this._observers,t,H).add(e),e}once(t,e){let r=(...s)=>{this.off(t,r),e(...s)};this.on(t,r)}off(t,e){let r=this._observers.get(t);r!==void 0&&(r.delete(e),r.size===0&&this._observers.delete(t))}emit(t,e){return J((this._observers.get(t)||T()).values()).forEach(r=>r(...e))}destroy(){this._observers=T()}},He=class{constructor(){this._observers=T()}on(t,e){F(this._observers,t,H).add(e)}once(t,e){let r=(...s)=>{this.off(t,r),e(...s)};this.on(t,r)}off(t,e){let r=this._observers.get(t);r!==void 0&&(r.delete(e),r.size===0&&this._observers.delete(t))}emit(t,e){return J((this._observers.get(t)||T()).values()).forEach(r=>r(...e))}destroy(){this._observers=T()}};var O=Math.floor;var Ft=Math.abs;var ht=(n,t)=>n<t?n:t,q=(n,t)=>n>t?n:t,zl=Number.isNaN,rs=Math.pow;var Ye=n=>n!==0?n<0:1/n<0;var Pn=Number.MAX_SAFE_INTEGER,Gl=Number.MIN_SAFE_INTEGER,Jl=1<<31;var ss=Number.isInteger||(n=>typeof n=="number"&&isFinite(n)&&O(n)===n),ql=Number.isNaN,Wl=Number.parseInt;var jn=String.fromCharCode,Kl=String.fromCodePoint,Xl=jn(65535),Co=n=>n.toLowerCase(),Ao=/^\s*/g,Do=n=>n.replace(Ao,""),Io=/([A-Z])/g,Hn=(n,t)=>Do(n.replace(Io,e=>`${t}${Co(e)}`));var To=n=>{let t=unescape(encodeURIComponent(n)),e=t.length,r=new Uint8Array(e);for(let s=0;s<e;s++)r[s]=t.codePointAt(s);return r},jt=typeof TextEncoder!="undefined"?new TextEncoder:null,Vo=n=>jt.encode(n),os=jt?Vo:To;var Pt=typeof TextDecoder=="undefined"?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});Pt&&Pt.decode(new Uint8Array).length===1&&(Pt=null);var Et=class{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}},D=()=>new Et;var Ge=n=>{let t=n.cpos;for(let e=0;e<n.bufs.length;e++)t+=n.bufs[e].length;return t};var U=n=>{let t=new Uint8Array(Ge(n)),e=0;for(let r=0;r<n.bufs.length;r++){let s=n.bufs[r];t.set(s,e),e+=s.length}return t.set(new Uint8Array(n.cbuf.buffer,0,n.cpos),e),t},vo=(n,t)=>{let e=n.cbuf.length;e-n.cpos<t&&(n.bufs.push(new Uint8Array(n.cbuf.buffer,0,n.cpos)),n.cbuf=new Uint8Array(q(e,t)*2),n.cpos=0)},V=(n,t)=>{let e=n.cbuf.length;n.cpos===e&&(n.bufs.push(n.cbuf),n.cbuf=new Uint8Array(e*2),n.cpos=0),n.cbuf[n.cpos++]=t};var Je=V;var m=(n,t)=>{for(;t>127;)V(n,128|127&t),t=O(t/128);V(n,127&t)},qe=(n,t)=>{let e=Ye(t);for(e&&(t=-t),V(n,(t>63?128:0)|(e?64:0)|63&t),t=O(t/64);t>0;)V(n,(t>127?128:0)|127&t),t=O(t/128)},Yn=new Uint8Array(3e4),Mo=Yn.length/3,Lo=(n,t)=>{if(t.length<Mo){let e=jt.encodeInto(t,Yn).written||0;m(n,e);for(let r=0;r<e;r++)V(n,Yn[r])}else _(n,os(t))},Oo=(n,t)=>{let e=unescape(encodeURIComponent(t)),r=e.length;m(n,r);for(let s=0;s<r;s++)V(n,e.codePointAt(s))},st=jt&&jt.encodeInto?Lo:Oo;var pe=(n,t)=>{let e=n.cbuf.length,r=n.cpos,s=ht(e-r,t.length),i=t.length-s;n.cbuf.set(t.subarray(0,s),r),n.cpos+=s,i>0&&(n.bufs.push(n.cbuf),n.cbuf=new Uint8Array(q(e*2,i)),n.cbuf.set(t.subarray(s)),n.cpos=i)},_=(n,t)=>{m(n,t.byteLength),pe(n,t)},$n=(n,t)=>{vo(n,t);let e=new DataView(n.cbuf.buffer,n.cpos,t);return n.cpos+=t,e},No=(n,t)=>$n(n,4).setFloat32(0,t,!1),Bo=(n,t)=>$n(n,8).setFloat64(0,t,!1),Ro=(n,t)=>$n(n,8).setBigInt64(0,t,!1);var ls=new DataView(new ArrayBuffer(4)),Fo=n=>(ls.setFloat32(0,n),ls.getFloat32(0)===n),Yt=(n,t)=>{switch(typeof t){case"string":V(n,119),st(n,t);break;case"number":ss(t)&&Ft(t)<=2147483647?(V(n,125),qe(n,t)):Fo(t)?(V(n,124),No(n,t)):(V(n,123),Bo(n,t));break;case"bigint":V(n,122),Ro(n,t);break;case"object":if(t===null)V(n,126);else if(fe(t)){V(n,117),m(n,t.length);for(let e=0;e<t.length;e++)Yt(n,t[e])}else if(t instanceof Uint8Array)V(n,116),_(n,t);else{V(n,118);let e=Object.keys(t);m(n,e.length);for(let r=0;r<e.length;r++){let s=e[r];st(n,s),Yt(n,t[s])}}break;case"boolean":V(n,t?120:121);break;default:V(n,127)}},ge=class extends Et{constructor(t){super(),this.w=t,this.s=null,this.count=0}write(t){this.s===t?this.count++:(this.count>0&&m(this,this.count-1),this.count=1,this.w(this,t),this.s=t)}};var as=n=>{n.count>0&&(qe(n.encoder,n.count===1?n.s:-n.s),n.count>1&&m(n.encoder,n.count-2))},Ct=class{constructor(){this.encoder=new Et,this.s=0,this.count=0}write(t){this.s===t?this.count++:(as(this),this.count=1,this.s=t)}toUint8Array(){return as(this),U(this.encoder)}};var hs=n=>{if(n.count>0){let t=n.diff*2+(n.count===1?0:1);qe(n.encoder,t),n.count>1&&m(n.encoder,n.count-2)}},$t=class{constructor(){this.encoder=new Et,this.s=0,this.count=0,this.diff=0}write(t){this.diff===t-this.s?(this.s=t,this.count++):(hs(this),this.count=1,this.diff=t-this.s,this.s=t)}toUint8Array(){return hs(this),U(this.encoder)}},ze=class{constructor(){this.sarr=[],this.s="",this.lensE=new Ct}write(t){this.s+=t,this.s.length>19&&(this.sarr.push(this.s),this.s=""),this.lensE.write(t.length)}toUint8Array(){let t=new Et;return this.sarr.push(this.s),this.s="",st(t,this.sarr.join("")),pe(t,this.lensE.toUint8Array()),U(t)}};var Q=n=>new Error(n),W=()=>{throw Q("Method unimplemented")},$=()=>{throw Q("Unexpected case")};var us=Q("Unexpected end of array"),fs=Q("Integer out of Range"),zt=class{constructor(t){this.arr=t,this.pos=0}},X=n=>new zt(n),gs=n=>n.pos!==n.arr.length;var Po=(n,t)=>{let e=new Uint8Array(n.arr.buffer,n.pos+n.arr.byteOffset,t);return n.pos+=t,e},I=n=>Po(n,w(n));var At=n=>n.arr[n.pos++];var w=n=>{let t=0,e=1,r=n.arr.length;for(;n.pos<r;){let s=n.arr[n.pos++];if(t=t+(s&127)*e,e*=128,s<128)return t;if(t>Pn)throw fs}throw us},Xe=n=>{let t=n.arr[n.pos++],e=t&63,r=64,s=(t&64)>0?-1:1;if(!(t&128))return s*e;let i=n.arr.length;for(;n.pos<i;){if(t=n.arr[n.pos++],e=e+(t&127)*r,r*=128,t<128)return s*e;if(e>Pn)throw fs}throw us};var jo=n=>{let t=w(n);if(t===0)return"";{let e=String.fromCodePoint(At(n));if(--t<100)for(;t--;)e+=String.fromCodePoint(At(n));else for(;t>0;){let r=t<1e4?t:1e4,s=n.arr.subarray(n.pos,n.pos+r);n.pos+=r,e+=String.fromCodePoint.apply(null,s),t-=r}return decodeURIComponent(escape(e))}},Ho=n=>Pt.decode(I(n)),K=Pt?Ho:jo;var zn=(n,t)=>{let e=new DataView(n.arr.buffer,n.arr.byteOffset+n.pos,t);return n.pos+=t,e},Yo=n=>zn(n,4).getFloat32(0,!1),$o=n=>zn(n,8).getFloat64(0,!1),zo=n=>zn(n,8).getBigInt64(0,!1);var Go=[n=>{},n=>null,Xe,Yo,$o,zo,n=>!1,n=>!0,K,n=>{let t=w(n),e={};for(let r=0;r<t;r++){let s=K(n);e[s]=Gt(n)}return e},n=>{let t=w(n),e=[];for(let r=0;r<t;r++)e.push(Gt(n));return e},I],Gt=n=>Go[127-At(n)](n),me=class extends zt{constructor(t,e){super(t),this.reader=e,this.s=null,this.count=0}read(){return this.count===0&&(this.s=this.reader(this),gs(this)?this.count=w(this)+1:this.count=-1),this.count--,this.s}};var Dt=class extends zt{constructor(t){super(t),this.s=0,this.count=0}read(){if(this.count===0){this.s=Xe(this);let t=Ye(this.s);this.count=1,t&&(this.s=-this.s,this.count=w(this)+2)}return this.count--,this.s}};var Jt=class extends zt{constructor(t){super(t),this.s=0,this.count=0,this.diff=0}read(){if(this.count===0){let t=Xe(this),e=t&1;this.diff=O(t/2),this.count=1,e&&(this.count=w(this)+2)}return this.s+=this.diff,this.count--,this.s}},Ke=class{constructor(t){this.decoder=new Dt(t),this.str=K(this.decoder),this.spos=0}read(){let t=this.spos+this.decoder.read(),e=this.str.slice(this.spos,t);return this.spos=t,e}};var ta=crypto.subtle,ps=crypto.getRandomValues.bind(crypto);var Gn=()=>ps(new Uint32Array(1))[0];var Jo=[1e7]+-1e3+-4e3+-8e3+-1e11,ms=()=>Jo.replace(/[018]/g,n=>(n^Gn()&15>>n/4).toString(16));var P=Date.now;var Jn=n=>new Promise(n);var ra=Promise.all.bind(Promise);var qn=n=>n===void 0?null:n;var Wn=class{constructor(){this.map=new Map}setItem(t,e){this.map.set(t,e)}getItem(t){return this.map.get(t)}},ws=new Wn,Kn=!0;try{typeof localStorage!="undefined"&&localStorage&&(ws=localStorage,Kn=!1)}catch(n){}var Ze=ws,ys=n=>Kn||addEventListener("storage",n),bs=n=>Kn||removeEventListener("storage",n);var ks=Object.assign,Us=Object.keys;var _s=(n,t)=>{for(let e in n)t(n[e],e)},Es=(n,t)=>{let e=[];for(let r in n)e.push(t(n[r],r));return e},Xn=n=>Us(n).length,Ss=n=>Us(n).length;var Cs=n=>{for(let t in n)return!1;return!0},Xo=(n,t)=>{for(let e in n)if(!t(n[e],e))return!1;return!0},Qn=(n,t)=>Object.prototype.hasOwnProperty.call(n,t),Zn=(n,t)=>n===t||Ss(n)===Ss(t)&&Xo(n,(e,r)=>(e!==void 0||Qn(t,r))&&t[r]===e),Qo=Object.freeze,tr=n=>{for(let t in n){let e=n[t];(typeof e=="object"||typeof e=="function")&&tr(n[t])}return Qo(n)};var nr=Symbol("Equality");var ye=(n,t,e=0)=>{try{for(;e<n.length;e++)n[e](...t)}finally{e<n.length&&ye(n,t,e+1)}};var As=n=>n;var qt=(n,t)=>{if(n===t)return!0;if(n==null||t==null||n.constructor!==t.constructor)return!1;if(n[nr]!=null)return n[nr](t);switch(n.constructor){case ArrayBuffer:n=new Uint8Array(n),t=new Uint8Array(t);case Uint8Array:{if(n.byteLength!==t.byteLength)return!1;for(let e=0;e<n.length;e++)if(n[e]!==t[e])return!1;break}case Set:{if(n.size!==t.size)return!1;for(let e of n)if(!t.has(e))return!1;break}case Map:{if(n.size!==t.size)return!1;for(let e of n.keys())if(!t.has(e)||!qt(n.get(e),t.get(e)))return!1;break}case Object:if(Xn(n)!==Xn(t))return!1;for(let e in n)if(!Qn(n,e)||!qt(n[e],t[e]))return!1;break;case Array:if(n.length!==t.length)return!1;for(let e=0;e<n.length;e++)if(!qt(n[e],t[e]))return!1;break;default:return!1}return!0},Ds=(n,t)=>t.includes(n);var it=typeof process!="undefined"&&process.release&&/node|io\.js/.test(process.release.name)&&Object.prototype.toString.call(typeof process!="undefined"?process:0)==="[object process]",tn=typeof window!="undefined"&&typeof document!="undefined"&&!it,sa=typeof navigator!="undefined"?/Mac/.test(navigator.platform):!1,Z,tc=[],ec=()=>{if(Z===void 0)if(it){Z=T();let n=process.argv,t=null;for(let e=0;e<n.length;e++){let r=n[e];r[0]==="-"?(t!==null&&Z.set(t,""),t=r):t!==null?(Z.set(t,r),t=null):tc.push(r)}t!==null&&Z.set(t,"")}else typeof location=="object"?(Z=T(),(location.search||"?").slice(1).split("&").forEach(n=>{if(n.length!==0){let[t,e]=n.split("=");Z.set(`--${Hn(t,"-")}`,e),Z.set(`-${Hn(t,"-")}`,e)}})):Z=T();return Z},sr=n=>ec().has(n);var be=n=>it?qn(process.env[n.toUpperCase().replaceAll("-","_")]):qn(Ze.getItem(n));var Is=n=>sr("--"+n)||be(n)!==null,ia=Is("production"),nc=it&&Ds(process.env.FORCE_COLOR,["true","1","2"]),Ts=nc||!sr("--no-colors")&&!Is("no-color")&&(!it||process.stdout.isTTY)&&(!it||sr("--color")||be("COLORTERM")!==null||(be("TERM")||"").includes("color"));var Vs=n=>new Uint8Array(n),rc=(n,t,e)=>new Uint8Array(n,t,e),vs=n=>new Uint8Array(n),sc=n=>{let t="";for(let e=0;e<n.byteLength;e++)t+=jn(n[e]);return btoa(t)},ic=n=>Buffer.from(n.buffer,n.byteOffset,n.byteLength).toString("base64"),oc=n=>{let t=atob(n),e=Vs(t.length);for(let r=0;r<t.length;r++)e[r]=t.charCodeAt(r);return e},cc=n=>{let t=Buffer.from(n,"base64");return rc(t.buffer,t.byteOffset,t.byteLength)},Ms=tn?sc:ic,Ls=tn?oc:cc;var Os=n=>{let t=Vs(n.byteLength);return t.set(n),t};var ir=class{constructor(t,e){this.left=t,this.right=e}},L=(n,t)=>new ir(n,t);var Bs=(n,t)=>n.forEach(e=>t(e.left,e.right));var tt=typeof document!="undefined"?document:{},lc=n=>tt.createElement(n),ac=()=>tt.createDocumentFragment(),hc=n=>tt.createTextNode(n),oa=typeof DOMParser!="undefined"?new DOMParser:null;var dc=(n,t)=>(Bs(t,(e,r)=>{r===!1?n.removeAttribute(e):r===!0?n.setAttribute(e,""):n.setAttribute(e,r)}),n);var uc=n=>{let t=ac();for(let e=0;e<n.length;e++)Ps(t,n[e]);return t},Rs=(n,t)=>(Ps(n,uc(t)),n);var xe=(n,t=[],e=[])=>Rs(dc(lc(n),t),e);var Wt=hc;var Fs=n=>Zr(n,(t,e)=>`${e}:${t};`).join("");var Ps=(n,t)=>n.appendChild(t),ca=tt.ELEMENT_NODE,la=tt.TEXT_NODE,aa=tt.CDATA_SECTION_NODE,ha=tt.COMMENT_NODE,da=tt.DOCUMENT_NODE,ua=tt.DOCUMENT_TYPE_NODE,fa=tt.DOCUMENT_FRAGMENT_NODE;var et=Symbol;var Se=et(),ke=et(),cr=et(),lr=et(),ar=et(),Ue=et(),hr=et(),Kt=et(),dr=et(),Hs=n=>{var s;n.length===1&&((s=n[0])==null?void 0:s.constructor)===Function&&(n=n[0]());let t=[],e=[],r=0;for(;r<n.length;r++){let i=n[r];if(i===void 0)break;if(i.constructor===String||i.constructor===Number)t.push(i);else if(i.constructor===Object)break}for(r>0&&e.push(t.join(""));r<n.length;r++){let i=n[r];i instanceof Symbol||e.push(i)}return e};var ga=P();var pc={[Se]:L("font-weight","bold"),[ke]:L("font-weight","normal"),[cr]:L("color","blue"),[ar]:L("color","green"),[lr]:L("color","grey"),[Ue]:L("color","red"),[hr]:L("color","purple"),[Kt]:L("color","orange"),[dr]:L("color","black")},mc=n=>{var o;n.length===1&&((o=n[0])==null?void 0:o.constructor)===Function&&(n=n[0]());let t=[],e=[],r=T(),s=[],i=0;for(;i<n.length;i++){let c=n[i],l=pc[c];if(l!==void 0)r.set(l.left,l.right);else{if(c===void 0)break;if(c.constructor===String||c.constructor===Number){let a=Fs(r);i>0||a.length>0?(t.push("%c"+c),e.push(a)):t.push(c)}else break}}for(i>0&&(s=e,s.unshift(t.join("")));i<n.length;i++){let c=n[i];c instanceof Symbol||s.push(c)}return s},Ys=Ts?mc:Hs,$s=(...n)=>{console.log(...Ys(n)),zs.forEach(t=>t.print(n))},ur=(...n)=>{console.warn(...Ys(n)),n.unshift(Kt),zs.forEach(t=>t.print(n))};var zs=H();var Gs=n=>({[Symbol.iterator](){return this},next:n}),Js=(n,t)=>Gs(()=>{let e;do e=n.next();while(!e.done&&!t(e.value));return e}),nn=(n,t)=>Gs(()=>{let{done:e,value:r}=n.next();return{done:e,value:e?void 0:t(r)}});var Ee=class{constructor(t,e){this.clock=t,this.len=e}},mt=class{constructor(){this.clients=new Map}},te=(n,t,e)=>t.clients.forEach((r,s)=>{let i=n.doc.store.clients.get(s);if(i!=null){let o=i[i.length-1],c=o.id.clock+o.length;for(let l=0,a=r[l];l<r.length&&a.clock<c;a=r[++l])Si(n,i,a.clock,a.len,e)}}),Sc=(n,t)=>{let e=0,r=n.length-1;for(;e<=r;){let s=O((e+r)/2),i=n[s],o=i.clock;if(o<=t){if(t<o+i.len)return s;e=s+1}else r=s-1}return null},Me=(n,t)=>{let e=n.clients.get(t.client);return e!==void 0&&Sc(e,t.clock)!==null},Tr=n=>{n.clients.forEach(t=>{t.sort((s,i)=>s.clock-i.clock);let e,r;for(e=1,r=1;e<t.length;e++){let s=t[r-1],i=t[e];s.clock+s.len>=i.clock?s.len=q(s.len,i.clock+i.len-s.clock):(r<e&&(t[r]=i),r++)}t.length=r})},gr=n=>{let t=new mt;for(let e=0;e<n.length;e++)n[e].clients.forEach((r,s)=>{if(!t.clients.has(s)){let i=r.slice();for(let o=e+1;o<n.length;o++)es(i,n[o].clients.get(s)||[]);t.clients.set(s,i)}});return Tr(t),t},Ce=(n,t,e,r)=>{F(n.clients,t,()=>[]).push(new Ee(e,r))},hi=()=>new mt,kc=n=>{let t=hi();return n.clients.forEach((e,r)=>{let s=[];for(let i=0;i<e.length;i++){let o=e[i];if(o.deleted){let c=o.id.clock,l=o.length;if(i+1<e.length)for(let a=e[i+1];i+1<e.length&&a.deleted;a=e[++i+1])l+=a.length;s.push(new Ee(c,l))}}s.length>0&&t.clients.set(r,s)}),t},oe=(n,t)=>{m(n.restEncoder,t.clients.size),J(t.clients.entries()).sort((e,r)=>r[0]-e[0]).forEach(([e,r])=>{n.resetDsCurVal(),m(n.restEncoder,e);let s=r.length;m(n.restEncoder,s);for(let i=0;i<s;i++){let o=r[i];n.writeDsClock(o.clock),n.writeDsLen(o.len)}})},Vr=n=>{let t=new mt,e=w(n.restDecoder);for(let r=0;r<e;r++){n.resetDsCurVal();let s=w(n.restDecoder),i=w(n.restDecoder);if(i>0){let o=F(t.clients,s,()=>[]);for(let c=0;c<i;c++)o.push(new Ee(n.readDsClock(),n.readDsLen()))}}return t},Ks=(n,t,e)=>{let r=new mt,s=w(n.restDecoder);for(let i=0;i<s;i++){n.resetDsCurVal();let o=w(n.restDecoder),c=w(n.restDecoder),l=e.clients.get(o)||[],a=E(e,o);for(let h=0;h<c;h++){let u=n.readDsClock(),d=u+n.readDsLen();if(u<a){a<d&&Ce(r,o,a,d-a);let f=rt(l,u),g=l[f];for(!g.deleted&&g.id.clock<u&&(l.splice(f+1,0,bn(t,g,u-g.id.clock)),f++);f<l.length&&(g=l[f++],g.id.clock<d);)g.deleted||(d<g.id.clock+g.length&&l.splice(f,0,bn(t,g,d-g.id.clock)),g.delete(t))}else Ce(r,o,u,d-u)}}if(r.clients.size>0){let i=new ot;return m(i.restEncoder,0),oe(i,r),i.toUint8Array()}return null};var di=Gn,nt=class extends Ut{constructor({guid:t=ms(),collectionid:e=null,gc:r=!0,gcFilter:s=()=>!0,meta:i=null,autoLoad:o=!1,shouldLoad:c=!0}={}){super(),this.gc=r,this.gcFilter=s,this.clientID=di(),this.guid=t,this.collectionid=e,this.share=new Map,this.store=new pn,this._transaction=null,this._transactionCleanups=[],this.subdocs=new Set,this._item=null,this.shouldLoad=c,this.autoLoad=o,this.meta=i,this.isLoaded=!1,this.isSynced=!1,this.isDestroyed=!1,this.whenLoaded=Jn(a=>{this.on("load",()=>{this.isLoaded=!0,a(this)})});let l=()=>Jn(a=>{let h=u=>{(u===void 0||u===!0)&&(this.off("sync",h),a())};this.on("sync",h)});this.on("sync",a=>{a===!1&&this.isSynced&&(this.whenSynced=l()),this.isSynced=a===void 0||a===!0,this.isSynced&&!this.isLoaded&&this.emit("load",[this])}),this.whenSynced=l()}load(){let t=this._item;t!==null&&!this.shouldLoad&&k(t.parent.doc,e=>{e.subdocsLoaded.add(this)},null,!0),this.shouldLoad=!0}getSubdocs(){return this.subdocs}getSubdocGuids(){return new Set(J(this.subdocs).map(t=>t.guid))}transact(t,e=null){return k(this,t,e)}get(t,e=A){let r=F(this.share,t,()=>{let i=new e;return i._integrate(this,null),i}),s=r.constructor;if(e!==A&&s!==e)if(s===A){let i=new e;i._map=r._map,r._map.forEach(o=>{for(;o!==null;o=o.left)o.parent=i}),i._start=r._start;for(let o=i._start;o!==null;o=o.right)o.parent=i;return i._length=r._length,this.share.set(t,i),i._integrate(this,null),i}else throw new Error(`Type with the name ${t} has already been defined with a different constructor`);return r}getArray(t=""){return this.get(t,pt)}getText(t=""){return this.get(t,bt)}getMap(t=""){return this.get(t,yt)}getXmlElement(t=""){return this.get(t,xt)}getXmlFragment(t=""){return this.get(t,ct)}toJSON(){let t={};return this.share.forEach((e,r)=>{t[r]=e.toJSON()}),t}destroy(){this.isDestroyed=!0,J(this.subdocs).forEach(e=>e.destroy());let t=this._item;if(t!==null){this._item=null;let e=t.content;e.doc=new nt({guid:this.guid,...e.opts,shouldLoad:!1}),e.doc._item=t,k(t.parent.doc,r=>{let s=e.doc;t.deleted||r.subdocsAdded.add(s),r.subdocsRemoved.add(this)},null,!0)}this.emit("destroyed",[!0]),this.emit("destroy",[this]),super.destroy()}},an=class{constructor(t){this.restDecoder=t}resetDsCurVal(){}readDsClock(){return w(this.restDecoder)}readDsLen(){return w(this.restDecoder)}},hn=class extends an{readLeftID(){return x(w(this.restDecoder),w(this.restDecoder))}readRightID(){return x(w(this.restDecoder),w(this.restDecoder))}readClient(){return w(this.restDecoder)}readInfo(){return At(this.restDecoder)}readString(){return K(this.restDecoder)}readParentInfo(){return w(this.restDecoder)===1}readTypeRef(){return w(this.restDecoder)}readLen(){return w(this.restDecoder)}readAny(){return Gt(this.restDecoder)}readBuf(){return Os(I(this.restDecoder))}readJSON(){return JSON.parse(K(this.restDecoder))}readKey(){return K(this.restDecoder)}},pr=class{constructor(t){this.dsCurrVal=0,this.restDecoder=t}resetDsCurVal(){this.dsCurrVal=0}readDsClock(){return this.dsCurrVal+=w(this.restDecoder),this.dsCurrVal}readDsLen(){let t=w(this.restDecoder)+1;return this.dsCurrVal+=t,t}},wt=class extends pr{constructor(t){super(t),this.keys=[],w(t),this.keyClockDecoder=new Jt(I(t)),this.clientDecoder=new Dt(I(t)),this.leftClockDecoder=new Jt(I(t)),this.rightClockDecoder=new Jt(I(t)),this.infoDecoder=new me(I(t),At),this.stringDecoder=new Ke(I(t)),this.parentInfoDecoder=new me(I(t),At),this.typeRefDecoder=new Dt(I(t)),this.lenDecoder=new Dt(I(t))}readLeftID(){return new gt(this.clientDecoder.read(),this.leftClockDecoder.read())}readRightID(){return new gt(this.clientDecoder.read(),this.rightClockDecoder.read())}readClient(){return this.clientDecoder.read()}readInfo(){return this.infoDecoder.read()}readString(){return this.stringDecoder.read()}readParentInfo(){return this.parentInfoDecoder.read()===1}readTypeRef(){return this.typeRefDecoder.read()}readLen(){return this.lenDecoder.read()}readAny(){return Gt(this.restDecoder)}readBuf(){return I(this.restDecoder)}readJSON(){return Gt(this.restDecoder)}readKey(){let t=this.keyClockDecoder.read();if(t<this.keys.length)return this.keys[t];{let e=this.stringDecoder.read();return this.keys.push(e),e}}},dn=class{constructor(){this.restEncoder=D()}toUint8Array(){return U(this.restEncoder)}resetDsCurVal(){}writeDsClock(t){m(this.restEncoder,t)}writeDsLen(t){m(this.restEncoder,t)}},It=class extends dn{writeLeftID(t){m(this.restEncoder,t.client),m(this.restEncoder,t.clock)}writeRightID(t){m(this.restEncoder,t.client),m(this.restEncoder,t.clock)}writeClient(t){m(this.restEncoder,t)}writeInfo(t){Je(this.restEncoder,t)}writeString(t){st(this.restEncoder,t)}writeParentInfo(t){m(this.restEncoder,t?1:0)}writeTypeRef(t){m(this.restEncoder,t)}writeLen(t){m(this.restEncoder,t)}writeAny(t){Yt(this.restEncoder,t)}writeBuf(t){_(this.restEncoder,t)}writeJSON(t){st(this.restEncoder,JSON.stringify(t))}writeKey(t){st(this.restEncoder,t)}},un=class{constructor(){this.restEncoder=D(),this.dsCurrVal=0}toUint8Array(){return U(this.restEncoder)}resetDsCurVal(){this.dsCurrVal=0}writeDsClock(t){let e=t-this.dsCurrVal;this.dsCurrVal=t,m(this.restEncoder,e)}writeDsLen(t){t===0&&$(),m(this.restEncoder,t-1),this.dsCurrVal+=t}},ot=class extends un{constructor(){super(),this.keyMap=new Map,this.keyClock=0,this.keyClockEncoder=new $t,this.clientEncoder=new Ct,this.leftClockEncoder=new $t,this.rightClockEncoder=new $t,this.infoEncoder=new ge(Je),this.stringEncoder=new ze,this.parentInfoEncoder=new ge(Je),this.typeRefEncoder=new Ct,this.lenEncoder=new Ct}toUint8Array(){let t=D();return m(t,0),_(t,this.keyClockEncoder.toUint8Array()),_(t,this.clientEncoder.toUint8Array()),_(t,this.leftClockEncoder.toUint8Array()),_(t,this.rightClockEncoder.toUint8Array()),_(t,U(this.infoEncoder)),_(t,this.stringEncoder.toUint8Array()),_(t,U(this.parentInfoEncoder)),_(t,this.typeRefEncoder.toUint8Array()),_(t,this.lenEncoder.toUint8Array()),pe(t,U(this.restEncoder)),U(t)}writeLeftID(t){this.clientEncoder.write(t.client),this.leftClockEncoder.write(t.clock)}writeRightID(t){this.clientEncoder.write(t.client),this.rightClockEncoder.write(t.clock)}writeClient(t){this.clientEncoder.write(t)}writeInfo(t){this.infoEncoder.write(t)}writeString(t){this.stringEncoder.write(t)}writeParentInfo(t){this.parentInfoEncoder.write(t?1:0)}writeTypeRef(t){this.typeRefEncoder.write(t)}writeLen(t){this.lenEncoder.write(t)}writeAny(t){Yt(this.restEncoder,t)}writeBuf(t){_(this.restEncoder,t)}writeJSON(t){Yt(this.restEncoder,t)}writeKey(t){let e=this.keyMap.get(t);e===void 0?(this.keyClockEncoder.write(this.keyClock++),this.stringEncoder.write(t)):this.keyClockEncoder.write(e)}},Uc=(n,t,e,r)=>{r=q(r,t[0].id.clock);let s=rt(t,r);m(n.restEncoder,t.length-s),n.writeClient(e),m(n.restEncoder,r);let i=t[s];i.write(n,r-i.id.clock);for(let o=s+1;o<t.length;o++)t[o].write(n,0)},vr=(n,t,e)=>{let r=new Map;e.forEach((s,i)=>{E(t,i)>s&&r.set(i,s)}),xn(t).forEach((s,i)=>{e.has(i)||r.set(i,0)}),m(n.restEncoder,r.size),J(r.entries()).sort((s,i)=>i[0]-s[0]).forEach(([s,i])=>{Uc(n,t.clients.get(s),s,i)})},_c=(n,t)=>{let e=T(),r=w(n.restDecoder);for(let s=0;s<r;s++){let i=w(n.restDecoder),o=new Array(i),c=n.readClient(),l=w(n.restDecoder);e.set(c,{i:0,refs:o});for(let a=0;a<i;a++){let h=n.readInfo();switch(31&h){case 0:{let u=n.readLen();o[a]=new B(x(c,l),u),l+=u;break}case 10:{let u=w(n.restDecoder);o[a]=new R(x(c,l),u),l+=u;break}default:{let u=(h&192)===0,d=new S(x(c,l),null,(h&128)===128?n.readLeftID():null,null,(h&64)===64?n.readRightID():null,u?n.readParentInfo()?t.get(n.readString()):n.readLeftID():null,u&&(h&32)===32?n.readString():null,ji(n,h));o[a]=d,l+=d.length}}}}return e},Ec=(n,t,e)=>{let r=[],s=J(e.keys()).sort((f,g)=>f-g);if(s.length===0)return null;let i=()=>{if(s.length===0)return null;let f=e.get(s[s.length-1]);for(;f.refs.length===f.i;)if(s.pop(),s.length>0)f=e.get(s[s.length-1]);else return null;return f},o=i();if(o===null)return null;let c=new pn,l=new Map,a=(f,g)=>{let b=l.get(f);(b==null||b>g)&&l.set(f,g)},h=o.refs[o.i++],u=new Map,d=()=>{for(let f of r){let g=f.id.client,b=e.get(g);b?(b.i--,c.clients.set(g,b.refs.slice(b.i)),e.delete(g),b.i=0,b.refs=[]):c.clients.set(g,[f]),s=s.filter(p=>p!==g)}r.length=0};for(;;){if(h.constructor!==R){let g=F(u,h.id.client,()=>E(t,h.id.client))-h.id.clock;if(g<0)r.push(h),a(h.id.client,h.id.clock-1),d();else{let b=h.getMissing(n,t);if(b!==null){r.push(h);let p=e.get(b)||{refs:[],i:0};if(p.refs.length===p.i)a(b,E(t,b)),d();else{h=p.refs[p.i++];continue}}else(g===0||g<h.length)&&(h.integrate(n,g),u.set(h.id.client,h.id.clock+h.length))}}if(r.length>0)h=r.pop();else if(o!==null&&o.i<o.refs.length)h=o.refs[o.i++];else{if(o=i(),o===null)break;h=o.refs[o.i++]}}if(c.clients.size>0){let f=new ot;return vr(f,c,new Map),m(f.restEncoder,0),{missing:l,update:f.toUint8Array()}}return null},Cc=(n,t)=>vr(n,t.doc.store,t.beforeState),Ac=(n,t,e,r=new wt(n))=>k(t,s=>{s.local=!1;let i=!1,o=s.doc,c=o.store,l=_c(r,o),a=Ec(s,c,l),h=c.pendingStructs;if(h){for(let[d,f]of h.missing)if(f<E(c,d)){i=!0;break}if(a){for(let[d,f]of a.missing){let g=h.missing.get(d);(g==null||g>f)&&h.missing.set(d,f)}h.update=mn([h.update,a.update])}}else c.pendingStructs=a;let u=Ks(r,s,c);if(c.pendingDs){let d=new wt(X(c.pendingDs));w(d.restDecoder);let f=Ks(d,s,c);u&&f?c.pendingDs=mn([u,f]):c.pendingDs=u||f}else c.pendingDs=u;if(i){let d=c.pendingStructs.update;c.pendingStructs=null,ui(s.doc,d)}},e,!1);var ui=(n,t,e,r=wt)=>{let s=X(t);Ac(s,n,e,new r(s))},fi=(n,t,e)=>ui(n,t,e,hn),Dc=(n,t,e=new Map)=>{vr(n,t.store,e),oe(n,kc(t.store))},Ic=(n,t=new Uint8Array([0]),e=new ot)=>{let r=pi(t);Dc(e,n,r);let s=[e.toUint8Array()];if(n.store.pendingDs&&s.push(n.store.pendingDs),n.store.pendingStructs&&s.push(Yc(n.store.pendingStructs.update,t)),s.length>1){if(e.constructor===It)return jc(s.map((i,o)=>o===0?i:zc(i)));if(e.constructor===ot)return mn(s)}return s[0]},gi=(n,t)=>Ic(n,t,new It),Tc=n=>{let t=new Map,e=w(n.restDecoder);for(let r=0;r<e;r++){let s=w(n.restDecoder),i=w(n.restDecoder);t.set(s,i)}return t},pi=n=>Tc(new an(X(n))),mi=(n,t)=>(m(n.restEncoder,t.size),J(t.entries()).sort((e,r)=>r[0]-e[0]).forEach(([e,r])=>{m(n.restEncoder,e),m(n.restEncoder,r)}),n),Vc=(n,t)=>mi(n,xn(t.store)),vc=(n,t=new un)=>(n instanceof Map?mi(t,n):Vc(t,n),t.toUint8Array()),wi=n=>vc(n,new dn),mr=class{constructor(){this.l=[]}},Xs=()=>new mr,Qs=(n,t)=>n.l.push(t),Zs=(n,t)=>{let e=n.l,r=e.length;n.l=e.filter(s=>t!==s),r===n.l.length&&console.error("[yjs] Tried to remove event handler that doesn't exist.")},yi=(n,t,e)=>ye(n.l,[t,e]),gt=class{constructor(t,e){this.client=t,this.clock=e}},Qt=(n,t)=>n===t||n!==null&&t!==null&&n.client===t.client&&n.clock===t.clock,x=(n,t)=>new gt(n,t);var bi=n=>{for(let[t,e]of n.doc.share.entries())if(e===n)return t;throw $()},fn=(n,t)=>{for(;t!==null;){if(t.parent===n)return!0;t=t.parent._item}return!1};var gn=class{constructor(t,e,r,s=0){this.type=t,this.tname=e,this.item=r,this.assoc=s}},Mr=n=>{let t={};return n.type&&(t.type=n.type),n.tname&&(t.tname=n.tname),n.item&&(t.item=n.item),n.assoc!=null&&(t.assoc=n.assoc),t},St=n=>{var t;return new gn(n.type==null?null:x(n.type.client,n.type.clock),(t=n.tname)!=null?t:null,n.item==null?null:x(n.item.client,n.item.clock),n.assoc==null?0:n.assoc)},wr=class{constructor(t,e,r=0){this.type=t,this.index=e,this.assoc=r}},Mc=(n,t,e=0)=>new wr(n,t,e),rn=(n,t,e)=>{let r=null,s=null;return n._item===null?s=bi(n):r=x(n._item.id.client,n._item.id.clock),new gn(r,s,t,e)},Le=(n,t,e=0)=>{let r=n._start;if(e<0){if(t===0)return rn(n,null,e);t--}for(;r!==null;){if(!r.deleted&&r.countable){if(r.length>t)return rn(n,x(r.id.client,r.id.clock+t),e);t-=r.length}if(r.right===null&&e<0)return rn(n,r.lastId,e);r=r.right}return rn(n,null,e)};var Lc=(n,t)=>{let e=Zt(n,t),r=t.clock-e.id.clock;return{item:e,diff:r}},Oe=(n,t,e=!0)=>{let r=t.store,s=n.item,i=n.type,o=n.tname,c=n.assoc,l=null,a=0;if(s!==null){if(E(r,s.client)<=s.clock)return null;let h=e?Dr(r,s):Lc(r,s),u=h.item;if(!(u instanceof S))return null;if(l=u.parent,l._item===null||!l._item.deleted){a=u.deleted||!u.countable?0:h.diff+(c>=0?0:1);let d=u.left;for(;d!==null;)!d.deleted&&d.countable&&(a+=d.length),d=d.left}}else{if(o!==null)l=t.get(o);else if(i!==null){if(E(r,i.client)<=i.clock)return null;let{item:h}=e?Dr(r,i):{item:Zt(r,i)};if(h instanceof S&&h.content instanceof G)l=h.content.type;else return null}else throw $();c>=0?a=l._length:a=0}return Mc(l,a,n.assoc)},Lr=(n,t)=>n===t||n!==null&&t!==null&&n.tname===t.tname&&Qt(n.item,t.item)&&Qt(n.type,t.type)&&n.assoc===t.assoc,yr=class{constructor(t,e){this.ds=t,this.sv=e}};var Oc=(n,t)=>new yr(n,t),Sa=Oc(hi(),new Map);var Xt=(n,t)=>t===void 0?!n.deleted:t.sv.has(n.id.client)&&(t.sv.get(n.id.client)||0)>n.id.clock&&!Me(t.ds,n.id),br=(n,t)=>{let e=F(n.meta,br,H),r=n.doc.store;e.has(t)||(t.sv.forEach((s,i)=>{s<E(r,i)&&N(n,x(i,s))}),te(n,t.ds,s=>{}),e.add(t))};var pn=class{constructor(){this.clients=new Map,this.pendingStructs=null,this.pendingDs=null}},xn=n=>{let t=new Map;return n.clients.forEach((e,r)=>{let s=e[e.length-1];t.set(r,s.id.clock+s.length)}),t},E=(n,t)=>{let e=n.clients.get(t);if(e===void 0)return 0;let r=e[e.length-1];return r.id.clock+r.length},xi=(n,t)=>{let e=n.clients.get(t.id.client);if(e===void 0)e=[],n.clients.set(t.id.client,e);else{let r=e[e.length-1];if(r.id.clock+r.length!==t.id.clock)throw $()}e.push(t)},rt=(n,t)=>{let e=0,r=n.length-1,s=n[r],i=s.id.clock;if(i===t)return r;let o=O(t/(i+s.length-1)*r);for(;e<=r;){if(s=n[o],i=s.id.clock,i<=t){if(t<i+s.length)return o;e=o+1}else r=o-1;o=O((e+r)/2)}throw $()},Nc=(n,t)=>{let e=n.clients.get(t.client);return e[rt(e,t.clock)]},Zt=Nc,xr=(n,t,e)=>{let r=rt(t,e),s=t[r];return s.id.clock<e&&s instanceof S?(t.splice(r+1,0,bn(n,s,e-s.id.clock)),r+1):r},N=(n,t)=>{let e=n.doc.store.clients.get(t.client);return e[xr(n,e,t.clock)]},ti=(n,t,e)=>{let r=t.clients.get(e.client),s=rt(r,e.clock),i=r[s];return e.clock!==i.id.clock+i.length-1&&i.constructor!==B&&r.splice(s+1,0,bn(n,i,e.clock-i.id.clock+1)),i},Bc=(n,t,e)=>{let r=n.clients.get(t.id.client);r[rt(r,t.id.clock)]=e},Si=(n,t,e,r,s)=>{if(r===0)return;let i=e+r,o=xr(n,t,e),c;do c=t[o++],i<c.id.clock+c.length&&xr(n,t,i),s(c);while(o<t.length&&t[o].id.clock<i)},Sr=class{constructor(t,e,r){this.doc=t,this.deleteSet=new mt,this.beforeState=xn(t.store),this.afterState=new Map,this.changed=new Map,this.changedParentTypes=new Map,this._mergeStructs=[],this.origin=e,this.meta=new Map,this.local=r,this.subdocsAdded=new Set,this.subdocsRemoved=new Set,this.subdocsLoaded=new Set,this._needFormattingCleanup=!1}},ei=(n,t)=>t.deleteSet.clients.size===0&&!ts(t.afterState,(e,r)=>t.beforeState.get(r)!==e)?!1:(Tr(t.deleteSet),Cc(n,t),oe(n,t.deleteSet),!0),ni=(n,t,e)=>{let r=t._item;(r===null||r.id.clock<(n.beforeState.get(r.id.client)||0)&&!r.deleted)&&F(n.changed,t,H).add(e)},cn=(n,t)=>{let e=n[t],r=n[t-1],s=t;for(;s>0;e=r,r=n[--s-1]){if(r.deleted===e.deleted&&r.constructor===e.constructor&&r.mergeWith(e)){e instanceof S&&e.parentSub!==null&&e.parent._map.get(e.parentSub)===e&&e.parent._map.set(e.parentSub,r);continue}break}let i=t-s;return i&&n.splice(t+1-i,i),i},Rc=(n,t,e)=>{for(let[r,s]of n.clients.entries()){let i=t.clients.get(r);for(let o=s.length-1;o>=0;o--){let c=s[o],l=c.clock+c.len;for(let a=rt(i,c.clock),h=i[a];a<i.length&&h.id.clock<l;h=i[++a]){let u=i[a];if(c.clock+c.len<=u.id.clock)break;u instanceof S&&u.deleted&&!u.keep&&e(u)&&u.gc(t,!1)}}}},Fc=(n,t)=>{n.clients.forEach((e,r)=>{let s=t.clients.get(r);for(let i=e.length-1;i>=0;i--){let o=e[i],c=ht(s.length-1,1+rt(s,o.clock+o.len-1));for(let l=c,a=s[l];l>0&&a.id.clock>=o.clock;a=s[l])l-=1+cn(s,l)}})};var ki=(n,t)=>{if(t<n.length){let e=n[t],r=e.doc,s=r.store,i=e.deleteSet,o=e._mergeStructs;try{Tr(i),e.afterState=xn(e.doc.store),r.emit("beforeObserverCalls",[e,r]);let c=[];e.changed.forEach((l,a)=>c.push(()=>{(a._item===null||!a._item.deleted)&&a._callObserver(e,l)})),c.push(()=>{e.changedParentTypes.forEach((l,a)=>{a._dEH.l.length>0&&(a._item===null||!a._item.deleted)&&(l=l.filter(h=>h.target._item===null||!h.target._item.deleted),l.forEach(h=>{h.currentTarget=a,h._path=null}),l.sort((h,u)=>h.path.length-u.path.length),yi(a._dEH,l,e))})}),c.push(()=>r.emit("afterTransaction",[e,r])),ye(c,[]),e._needFormattingCleanup&&nl(e)}finally{r.gc&&Rc(i,s,r.gcFilter),Fc(i,s),e.afterState.forEach((h,u)=>{let d=e.beforeState.get(u)||0;if(d!==h){let f=s.clients.get(u),g=q(rt(f,d),1);for(let b=f.length-1;b>=g;)b-=1+cn(f,b)}});for(let h=o.length-1;h>=0;h--){let{client:u,clock:d}=o[h].id,f=s.clients.get(u),g=rt(f,d);g+1<f.length&&cn(f,g+1)>1||g>0&&cn(f,g)}if(!e.local&&e.afterState.get(r.clientID)!==e.beforeState.get(r.clientID)&&($s(Kt,Se,"[yjs] ",ke,Ue,"Changed the client-id because another client seems to be using it."),r.clientID=di()),r.emit("afterTransactionCleanup",[e,r]),r._observers.has("update")){let h=new It;ei(h,e)&&r.emit("update",[h.toUint8Array(),e.origin,r,e])}if(r._observers.has("updateV2")){let h=new ot;ei(h,e)&&r.emit("updateV2",[h.toUint8Array(),e.origin,r,e])}let{subdocsAdded:c,subdocsLoaded:l,subdocsRemoved:a}=e;(c.size>0||a.size>0||l.size>0)&&(c.forEach(h=>{h.clientID=r.clientID,h.collectionid==null&&(h.collectionid=r.collectionid),r.subdocs.add(h)}),a.forEach(h=>r.subdocs.delete(h)),r.emit("subdocs",[{loaded:l,added:c,removed:a},r,e]),a.forEach(h=>h.destroy())),n.length<=t+1?(r._transactionCleanups=[],r.emit("afterAllTransactions",[r,n])):ki(n,t+1)}}},k=(n,t,e=null,r=!0)=>{let s=n._transactionCleanups,i=!1,o=null;n._transaction===null&&(i=!0,n._transaction=new Sr(n,e,r),s.push(n._transaction),s.length===1&&n.emit("beforeAllTransactions",[n]),n.emit("beforeTransaction",[n._transaction,n]));try{o=t(n._transaction)}finally{if(i){let c=n._transaction===s[0];n._transaction=null,c&&ki(s,0)}}return o},kr=class{constructor(t,e){this.insertions=e,this.deletions=t,this.meta=new Map}},ri=(n,t,e)=>{te(n,e.deletions,r=>{r instanceof S&&t.scope.some(s=>s===n.doc||fn(s,r))&&Fr(r,!1)})},si=(n,t,e)=>{let r=null,s=n.doc,i=n.scope;k(s,c=>{for(;t.length>0&&n.currStackItem===null;){let l=s.store,a=t.pop(),h=new Set,u=[],d=!1;te(c,a.insertions,f=>{if(f instanceof S){if(f.redone!==null){let{item:g,diff:b}=Dr(l,f.id);b>0&&(g=N(c,x(g.id.client,g.id.clock+b))),f=g}!f.deleted&&i.some(g=>g===c.doc||fn(g,f))&&u.push(f)}}),te(c,a.deletions,f=>{f instanceof S&&i.some(g=>g===c.doc||fn(g,f))&&!Me(a.insertions,f.id)&&h.add(f)}),h.forEach(f=>{d=Pi(c,f,h,a.insertions,n.ignoreRemoteMapChanges,n)!==null||d});for(let f=u.length-1;f>=0;f--){let g=u[f];n.deleteFilter(g)&&(g.delete(c),d=!0)}n.currStackItem=d?a:null}c.changed.forEach((l,a)=>{l.has(null)&&a._searchMarker&&(a._searchMarker.length=0)}),r=c},n);let o=n.currStackItem;if(o!=null){let c=r.changedParentTypes;n.emit("stack-item-popped",[{stackItem:o,type:e,changedParentTypes:c,origin:n},n]),n.currStackItem=null}return o},ee=class extends Ut{constructor(t,{captureTimeout:e=500,captureTransaction:r=l=>!0,deleteFilter:s=()=>!0,trackedOrigins:i=new Set([null]),ignoreRemoteMapChanges:o=!1,doc:c=fe(t)?t[0].doc:t instanceof nt?t:t.doc}={}){super(),this.scope=[],this.doc=c,this.addToScope(t),this.deleteFilter=s,i.add(this),this.trackedOrigins=i,this.captureTransaction=r,this.undoStack=[],this.redoStack=[],this.undoing=!1,this.redoing=!1,this.currStackItem=null,this.lastChange=0,this.ignoreRemoteMapChanges=o,this.captureTimeout=e,this.afterTransactionHandler=l=>{if(!this.captureTransaction(l)||!this.scope.some(p=>l.changedParentTypes.has(p)||p===this.doc)||!this.trackedOrigins.has(l.origin)&&(!l.origin||!this.trackedOrigins.has(l.origin.constructor)))return;let a=this.undoing,h=this.redoing,u=a?this.redoStack:this.undoStack;a?this.stopCapturing():h||this.clear(!1,!0);let d=new mt;l.afterState.forEach((p,y)=>{let v=l.beforeState.get(y)||0,Bt=p-v;Bt>0&&Ce(d,y,v,Bt)});let f=P(),g=!1;if(this.lastChange>0&&f-this.lastChange<this.captureTimeout&&u.length>0&&!a&&!h){let p=u[u.length-1];p.deletions=gr([p.deletions,l.deleteSet]),p.insertions=gr([p.insertions,d])}else u.push(new kr(l.deleteSet,d)),g=!0;!a&&!h&&(this.lastChange=f),te(l,l.deleteSet,p=>{p instanceof S&&this.scope.some(y=>y===l.doc||fn(y,p))&&Fr(p,!0)});let b=[{stackItem:u[u.length-1],origin:l.origin,type:a?"redo":"undo",changedParentTypes:l.changedParentTypes},this];g?this.emit("stack-item-added",b):this.emit("stack-item-updated",b)},this.doc.on("afterTransaction",this.afterTransactionHandler),this.doc.on("destroy",()=>{this.destroy()})}addToScope(t){let e=new Set(this.scope);t=fe(t)?t:[t],t.forEach(r=>{e.has(r)||(e.add(r),(r instanceof A?r.doc!==this.doc:r!==this.doc)&&ur("[yjs#509] Not same Y.Doc"),this.scope.push(r))})}addTrackedOrigin(t){this.trackedOrigins.add(t)}removeTrackedOrigin(t){this.trackedOrigins.delete(t)}clear(t=!0,e=!0){(t&&this.canUndo()||e&&this.canRedo())&&this.doc.transact(r=>{t&&(this.undoStack.forEach(s=>ri(r,this,s)),this.undoStack=[]),e&&(this.redoStack.forEach(s=>ri(r,this,s)),this.redoStack=[]),this.emit("stack-cleared",[{undoStackCleared:t,redoStackCleared:e}])})}stopCapturing(){this.lastChange=0}undo(){this.undoing=!0;let t;try{t=si(this,this.undoStack,"undo")}finally{this.undoing=!1}return t}redo(){this.redoing=!0;let t;try{t=si(this,this.redoStack,"redo")}finally{this.redoing=!1}return t}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}destroy(){this.trackedOrigins.delete(this),this.doc.off("afterTransaction",this.afterTransactionHandler),super.destroy()}};function*Pc(n){let t=w(n.restDecoder);for(let e=0;e<t;e++){let r=w(n.restDecoder),s=n.readClient(),i=w(n.restDecoder);for(let o=0;o<r;o++){let c=n.readInfo();if(c===10){let l=w(n.restDecoder);yield new R(x(s,i),l),i+=l}else if(31&c){let l=(c&192)===0,a=new S(x(s,i),null,(c&128)===128?n.readLeftID():null,null,(c&64)===64?n.readRightID():null,l?n.readParentInfo()?n.readString():n.readLeftID():null,l&&(c&32)===32?n.readString():null,ji(n,c));yield a,i+=a.length}else{let l=n.readLen();yield new B(x(s,i),l),i+=l}}}}var Ae=class{constructor(t,e){this.gen=Pc(t),this.curr=null,this.done=!1,this.filterSkips=e,this.next()}next(){do this.curr=this.gen.next().value||null;while(this.filterSkips&&this.curr!==null&&this.curr.constructor===R);return this.curr}};var De=class{constructor(t){this.currClient=0,this.startClock=0,this.written=0,this.encoder=t,this.clientStructs=[]}},jc=n=>mn(n,hn,It);var Hc=(n,t)=>{if(n.constructor===B){let{client:e,clock:r}=n.id;return new B(x(e,r+t),n.length-t)}else if(n.constructor===R){let{client:e,clock:r}=n.id;return new R(x(e,r+t),n.length-t)}else{let e=n,{client:r,clock:s}=e.id;return new S(x(r,s+t),null,x(r,s+t-1),null,e.rightOrigin,e.parent,e.parentSub,e.content.splice(t))}},mn=(n,t=wt,e=ot)=>{if(n.length===1)return n[0];let r=n.map(h=>new t(X(h))),s=r.map(h=>new Ae(h,!0)),i=null,o=new e,c=new De(o);for(;s=s.filter(d=>d.curr!==null),s.sort((d,f)=>{if(d.curr.id.client===f.curr.id.client){let g=d.curr.id.clock-f.curr.id.clock;return g===0?d.curr.constructor===f.curr.constructor?0:d.curr.constructor===R?1:-1:g}else return f.curr.id.client-d.curr.id.client}),s.length!==0;){let h=s[0],u=h.curr.id.client;if(i!==null){let d=h.curr,f=!1;for(;d!==null&&d.id.clock+d.length<=i.struct.id.clock+i.struct.length&&d.id.client>=i.struct.id.client;)d=h.next(),f=!0;if(d===null||d.id.client!==u||f&&d.id.clock>i.struct.id.clock+i.struct.length)continue;if(u!==i.struct.id.client)ut(c,i.struct,i.offset),i={struct:d,offset:0},h.next();else if(i.struct.id.clock+i.struct.length<d.id.clock)if(i.struct.constructor===R)i.struct.length=d.id.clock+d.length-i.struct.id.clock;else{ut(c,i.struct,i.offset);let g=d.id.clock-i.struct.id.clock-i.struct.length;i={struct:new R(x(u,i.struct.id.clock+i.struct.length),g),offset:0}}else{let g=i.struct.id.clock+i.struct.length-d.id.clock;g>0&&(i.struct.constructor===R?i.struct.length-=g:d=Hc(d,g)),i.struct.mergeWith(d)||(ut(c,i.struct,i.offset),i={struct:d,offset:0},h.next())}}else i={struct:h.curr,offset:0},h.next();for(let d=h.curr;d!==null&&d.id.client===u&&d.id.clock===i.struct.id.clock+i.struct.length&&d.constructor!==R;d=h.next())ut(c,i.struct,i.offset),i={struct:d,offset:0}}i!==null&&(ut(c,i.struct,i.offset),i=null),Or(c);let l=r.map(h=>Vr(h)),a=gr(l);return oe(o,a),o.toUint8Array()},Yc=(n,t,e=wt,r=ot)=>{let s=pi(t),i=new r,o=new De(i),c=new e(X(n)),l=new Ae(c,!1);for(;l.curr;){let h=l.curr,u=h.id.client,d=s.get(u)||0;if(l.curr.constructor===R){l.next();continue}if(h.id.clock+h.length>d)for(ut(o,h,q(d-h.id.clock,0)),l.next();l.curr&&l.curr.id.client===u;)ut(o,l.curr,0),l.next();else for(;l.curr&&l.curr.id.client===u&&l.curr.id.clock+l.curr.length<=d;)l.next()}Or(o);let a=Vr(c);return oe(i,a),i.toUint8Array()};var Ui=n=>{n.written>0&&(n.clientStructs.push({written:n.written,restEncoder:U(n.encoder.restEncoder)}),n.encoder.restEncoder=D(),n.written=0)},ut=(n,t,e)=>{n.written>0&&n.currClient!==t.id.client&&Ui(n),n.written===0&&(n.currClient=t.id.client,n.encoder.writeClient(t.id.client),m(n.encoder.restEncoder,t.id.clock+e)),t.write(n.encoder,e),n.written++},Or=n=>{Ui(n);let t=n.encoder.restEncoder;m(t,n.clientStructs.length);for(let e=0;e<n.clientStructs.length;e++){let r=n.clientStructs[e];m(t,r.written),pe(t,r.restEncoder)}},$c=(n,t,e,r)=>{let s=new e(X(n)),i=new Ae(s,!1),o=new r,c=new De(o);for(let a=i.curr;a!==null;a=i.next())ut(c,t(a),0);Or(c);let l=Vr(s);return oe(o,l),o.toUint8Array()};var zc=n=>$c(n,As,wt,It),ii="You must not compute changes after the event-handler fired.",ne=class{constructor(t,e){this.target=t,this.currentTarget=t,this.transaction=e,this._changes=null,this._keys=null,this._delta=null,this._path=null}get path(){return this._path||(this._path=Gc(this.currentTarget,this.target))}deletes(t){return Me(this.transaction.deleteSet,t.id)}get keys(){if(this._keys===null){if(this.transaction.doc._transactionCleanups.length===0)throw Q(ii);let t=new Map,e=this.target;this.transaction.changed.get(e).forEach(s=>{if(s!==null){let i=e._map.get(s),o,c;if(this.adds(i)){let l=i.left;for(;l!==null&&this.adds(l);)l=l.left;if(this.deletes(i))if(l!==null&&this.deletes(l))o="delete",c=je(l.content.getContent());else return;else l!==null&&this.deletes(l)?(o="update",c=je(l.content.getContent())):(o="add",c=void 0)}else if(this.deletes(i))o="delete",c=je(i.content.getContent());else return;t.set(s,{action:o,oldValue:c})}}),this._keys=t}return this._keys}get delta(){return this.changes.delta}adds(t){return t.id.clock>=(this.transaction.beforeState.get(t.id.client)||0)}get changes(){let t=this._changes;if(t===null){if(this.transaction.doc._transactionCleanups.length===0)throw Q(ii);let e=this.target,r=H(),s=H(),i=[];if(t={added:r,deleted:s,delta:i,keys:this.keys},this.transaction.changed.get(e).has(null)){let c=null,l=()=>{c&&i.push(c)};for(let a=e._start;a!==null;a=a.right)a.deleted?this.deletes(a)&&!this.adds(a)&&((c===null||c.delete===void 0)&&(l(),c={delete:0}),c.delete+=a.length,s.add(a)):this.adds(a)?((c===null||c.insert===void 0)&&(l(),c={insert:[]}),c.insert=c.insert.concat(a.content.getContent()),r.add(a)):((c===null||c.retain===void 0)&&(l(),c={retain:0}),c.retain+=a.length);c!==null&&c.retain===void 0&&l()}this._changes=t}return t}},Gc=(n,t)=>{let e=[];for(;t._item!==null&&t!==n;){if(t._item.parentSub!==null)e.unshift(t._item.parentSub);else{let r=0,s=t._item.parent._start;for(;s!==t._item&&s!==null;)!s.deleted&&s.countable&&(r+=s.length),s=s.right;e.unshift(r)}t=t._item.parent}return e},M=()=>{ur("Invalid access: Add Yjs type to a document before reading data.")},_i=80,Nr=0,Ur=class{constructor(t,e){t.marker=!0,this.p=t,this.index=e,this.timestamp=Nr++}},Jc=n=>{n.timestamp=Nr++},Ei=(n,t,e)=>{n.p.marker=!1,n.p=t,t.marker=!0,n.index=e,n.timestamp=Nr++},qc=(n,t,e)=>{if(n.length>=_i){let r=n.reduce((s,i)=>s.timestamp<i.timestamp?s:i);return Ei(r,t,e),r}else{let r=new Ur(t,e);return n.push(r),r}},Sn=(n,t)=>{if(n._start===null||t===0||n._searchMarker===null)return null;let e=n._searchMarker.length===0?null:n._searchMarker.reduce((i,o)=>Ft(t-i.index)<Ft(t-o.index)?i:o),r=n._start,s=0;for(e!==null&&(r=e.p,s=e.index,Jc(e));r.right!==null&&s<t;){if(!r.deleted&&r.countable){if(t<s+r.length)break;s+=r.length}r=r.right}for(;r.left!==null&&s>t;)r=r.left,!r.deleted&&r.countable&&(s-=r.length);for(;r.left!==null&&r.left.id.client===r.id.client&&r.left.id.clock+r.left.length===r.id.clock;)r=r.left,!r.deleted&&r.countable&&(s-=r.length);return e!==null&&Ft(e.index-s)<r.parent.length/_i?(Ei(e,r,s),e):qc(n._searchMarker,r,s)},Ie=(n,t,e)=>{for(let r=n.length-1;r>=0;r--){let s=n[r];if(e>0){let i=s.p;for(i.marker=!1;i&&(i.deleted||!i.countable);)i=i.left,i&&!i.deleted&&i.countable&&(s.index-=i.length);if(i===null||i.marker===!0){n.splice(r,1);continue}s.p=i,i.marker=!0}(t<s.index||e>0&&t===s.index)&&(s.index=q(t,s.index+e))}};var kn=(n,t,e)=>{let r=n,s=t.changedParentTypes;for(;F(s,n,()=>[]).push(e),n._item!==null;)n=n._item.parent;yi(r._eH,e,t)},A=class{constructor(){this._item=null,this._map=new Map,this._start=null,this.doc=null,this._length=0,this._eH=Xs(),this._dEH=Xs(),this._searchMarker=null}get parent(){return this._item?this._item.parent:null}_integrate(t,e){this.doc=t,this._item=e}_copy(){throw W()}clone(){throw W()}_write(t){}get _first(){let t=this._start;for(;t!==null&&t.deleted;)t=t.right;return t}_callObserver(t,e){!t.local&&this._searchMarker&&(this._searchMarker.length=0)}observe(t){Qs(this._eH,t)}observeDeep(t){Qs(this._dEH,t)}unobserve(t){Zs(this._eH,t)}unobserveDeep(t){Zs(this._dEH,t)}toJSON(){}},Ci=(n,t,e)=>{var o;(o=n.doc)!=null||M(),t<0&&(t=n._length+t),e<0&&(e=n._length+e);let r=e-t,s=[],i=n._start;for(;i!==null&&r>0;){if(i.countable&&!i.deleted){let c=i.content.getContent();if(c.length<=t)t-=c.length;else{for(let l=t;l<c.length&&r>0;l++)s.push(c[l]),r--;t=0}}i=i.right}return s},Ai=n=>{var r;(r=n.doc)!=null||M();let t=[],e=n._start;for(;e!==null;){if(e.countable&&!e.deleted){let s=e.content.getContent();for(let i=0;i<s.length;i++)t.push(s[i])}e=e.right}return t};var Te=(n,t)=>{var s;let e=0,r=n._start;for((s=n.doc)!=null||M();r!==null;){if(r.countable&&!r.deleted){let i=r.content.getContent();for(let o=0;o<i.length;o++)t(i[o],e++,n)}r=r.right}},Di=(n,t)=>{let e=[];return Te(n,(r,s)=>{e.push(t(r,s,n))}),e},Wc=n=>{let t=n._start,e=null,r=0;return{[Symbol.iterator](){return this},next:()=>{if(e===null){for(;t!==null&&t.deleted;)t=t.right;if(t===null)return{done:!0,value:void 0};e=t.content.getContent(),r=0,t=t.right}let s=e[r++];return e.length<=r&&(e=null),{done:!1,value:s}}}},Ii=(n,t)=>{var s;(s=n.doc)!=null||M();let e=Sn(n,t),r=n._start;for(e!==null&&(r=e.p,t-=e.index);r!==null;r=r.right)if(!r.deleted&&r.countable){if(t<r.length)return r.content.getContent()[t];t-=r.length}},wn=(n,t,e,r)=>{let s=e,i=n.doc,o=i.clientID,c=i.store,l=e===null?t._start:e.right,a=[],h=()=>{a.length>0&&(s=new S(x(o,E(c,o)),s,s&&s.lastId,l,l&&l.id,t,null,new at(a)),s.integrate(n,0),a=[])};r.forEach(u=>{if(u===null)a.push(u);else switch(u.constructor){case Number:case Object:case Boolean:case Array:case String:a.push(u);break;default:switch(h(),u.constructor){case Uint8Array:case ArrayBuffer:s=new S(x(o,E(c,o)),s,s&&s.lastId,l,l&&l.id,t,null,new Tt(new Uint8Array(u))),s.integrate(n,0);break;case nt:s=new S(x(o,E(c,o)),s,s&&s.lastId,l,l&&l.id,t,null,new vt(u)),s.integrate(n,0);break;default:if(u instanceof A)s=new S(x(o,E(c,o)),s,s&&s.lastId,l,l&&l.id,t,null,new G(u)),s.integrate(n,0);else throw new Error("Unexpected content type in insert operation")}}}),h()},Ti=()=>Q("Length exceeded!"),Vi=(n,t,e,r)=>{if(e>t._length)throw Ti();if(e===0)return t._searchMarker&&Ie(t._searchMarker,e,r.length),wn(n,t,null,r);let s=e,i=Sn(t,e),o=t._start;for(i!==null&&(o=i.p,e-=i.index,e===0&&(o=o.prev,e+=o&&o.countable&&!o.deleted?o.length:0));o!==null;o=o.right)if(!o.deleted&&o.countable){if(e<=o.length){e<o.length&&N(n,x(o.id.client,o.id.clock+e));break}e-=o.length}return t._searchMarker&&Ie(t._searchMarker,s,r.length),wn(n,t,o,r)},Kc=(n,t,e)=>{let s=(t._searchMarker||[]).reduce((i,o)=>o.index>i.index?o:i,{index:0,p:t._start}).p;if(s)for(;s.right;)s=s.right;return wn(n,t,s,e)},vi=(n,t,e,r)=>{if(r===0)return;let s=e,i=r,o=Sn(t,e),c=t._start;for(o!==null&&(c=o.p,e-=o.index);c!==null&&e>0;c=c.right)!c.deleted&&c.countable&&(e<c.length&&N(n,x(c.id.client,c.id.clock+e)),e-=c.length);for(;r>0&&c!==null;)c.deleted||(r<c.length&&N(n,x(c.id.client,c.id.clock+r)),c.delete(n),r-=c.length),c=c.right;if(r>0)throw Ti();t._searchMarker&&Ie(t._searchMarker,s,-i+r)},yn=(n,t,e)=>{let r=t._map.get(e);r!==void 0&&r.delete(n)},Br=(n,t,e,r)=>{let s=t._map.get(e)||null,i=n.doc,o=i.clientID,c;if(r==null)c=new at([r]);else switch(r.constructor){case Number:case Object:case Boolean:case Array:case String:case Date:case BigInt:c=new at([r]);break;case Uint8Array:c=new Tt(r);break;case nt:c=new vt(r);break;default:if(r instanceof A)c=new G(r);else throw new Error("Unexpected content type")}new S(x(o,E(i.store,o)),s,s&&s.lastId,null,null,t,e,c).integrate(n,0)},Rr=(n,t)=>{var r;(r=n.doc)!=null||M();let e=n._map.get(t);return e!==void 0&&!e.deleted?e.content.getContent()[e.length-1]:void 0},Mi=n=>{var e;let t={};return(e=n.doc)!=null||M(),n._map.forEach((r,s)=>{r.deleted||(t[s]=r.content.getContent()[r.length-1])}),t},Li=(n,t)=>{var r;(r=n.doc)!=null||M();let e=n._map.get(t);return e!==void 0&&!e.deleted};var Xc=(n,t)=>{let e={};return n._map.forEach((r,s)=>{let i=r;for(;i!==null&&(!t.sv.has(i.id.client)||i.id.clock>=(t.sv.get(i.id.client)||0));)i=i.left;i!==null&&Xt(i,t)&&(e[s]=i.content.getContent()[i.length-1])}),e},sn=n=>{var t;return(t=n.doc)!=null||M(),Js(n._map.entries(),e=>!e[1].deleted)},_r=class extends ne{},pt=class extends A{constructor(){super(),this._prelimContent=[],this._searchMarker=[]}static from(t){let e=new pt;return e.push(t),e}_integrate(t,e){super._integrate(t,e),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new pt}clone(){let t=new pt;return t.insert(0,this.toArray().map(e=>e instanceof A?e.clone():e)),t}get length(){var t;return(t=this.doc)!=null||M(),this._length}_callObserver(t,e){super._callObserver(t,e),kn(this,t,new _r(this,t))}insert(t,e){this.doc!==null?k(this.doc,r=>{Vi(r,this,t,e)}):this._prelimContent.splice(t,0,...e)}push(t){this.doc!==null?k(this.doc,e=>{Kc(e,this,t)}):this._prelimContent.push(...t)}unshift(t){this.insert(0,t)}delete(t,e=1){this.doc!==null?k(this.doc,r=>{vi(r,this,t,e)}):this._prelimContent.splice(t,e)}get(t){return Ii(this,t)}toArray(){return Ai(this)}slice(t=0,e=this.length){return Ci(this,t,e)}toJSON(){return this.map(t=>t instanceof A?t.toJSON():t)}map(t){return Di(this,t)}forEach(t){Te(this,t)}[Symbol.iterator](){return Wc(this)}_write(t){t.writeTypeRef(bl)}},Qc=n=>new pt,Er=class extends ne{constructor(t,e,r){super(t,e),this.keysChanged=r}},yt=class extends A{constructor(t){super(),this._prelimContent=null,t===void 0?this._prelimContent=new Map:this._prelimContent=new Map(t)}_integrate(t,e){super._integrate(t,e),this._prelimContent.forEach((r,s)=>{this.set(s,r)}),this._prelimContent=null}_copy(){return new yt}clone(){let t=new yt;return this.forEach((e,r)=>{t.set(r,e instanceof A?e.clone():e)}),t}_callObserver(t,e){kn(this,t,new Er(this,t,e))}toJSON(){var e;(e=this.doc)!=null||M();let t={};return this._map.forEach((r,s)=>{if(!r.deleted){let i=r.content.getContent()[r.length-1];t[s]=i instanceof A?i.toJSON():i}}),t}get size(){return[...sn(this)].length}keys(){return nn(sn(this),t=>t[0])}values(){return nn(sn(this),t=>t[1].content.getContent()[t[1].length-1])}entries(){return nn(sn(this),t=>[t[0],t[1].content.getContent()[t[1].length-1]])}forEach(t){var e;(e=this.doc)!=null||M(),this._map.forEach((r,s)=>{r.deleted||t(r.content.getContent()[r.length-1],s,this)})}[Symbol.iterator](){return this.entries()}delete(t){this.doc!==null?k(this.doc,e=>{yn(e,this,t)}):this._prelimContent.delete(t)}set(t,e){return this.doc!==null?k(this.doc,r=>{Br(r,this,t,e)}):this._prelimContent.set(t,e),e}get(t){return Rr(this,t)}has(t){return Li(this,t)}clear(){this.doc!==null?k(this.doc,t=>{this.forEach(function(e,r,s){yn(t,s,r)})}):this._prelimContent.clear()}_write(t){t.writeTypeRef(xl)}},Zc=n=>new yt,ft=(n,t)=>n===t||typeof n=="object"&&typeof t=="object"&&n&&t&&Zn(n,t),Ve=class{constructor(t,e,r,s){this.left=t,this.right=e,this.index=r,this.currentAttributes=s}forward(){switch(this.right===null&&$(),this.right.content.constructor){case C:this.right.deleted||ce(this.currentAttributes,this.right.content);break;default:this.right.deleted||(this.index+=this.right.length);break}this.left=this.right,this.right=this.right.right}},oi=(n,t,e)=>{for(;t.right!==null&&e>0;){switch(t.right.content.constructor){case C:t.right.deleted||ce(t.currentAttributes,t.right.content);break;default:t.right.deleted||(e<t.right.length&&N(n,x(t.right.id.client,t.right.id.clock+e)),t.index+=t.right.length,e-=t.right.length);break}t.left=t.right,t.right=t.right.right}return t},on=(n,t,e,r)=>{let s=new Map,i=r?Sn(t,e):null;if(i){let o=new Ve(i.p.left,i.p,i.index,s);return oi(n,o,e-i.index)}else{let o=new Ve(null,t._start,0,s);return oi(n,o,e)}},Oi=(n,t,e,r)=>{for(;e.right!==null&&(e.right.deleted===!0||e.right.content.constructor===C&&ft(r.get(e.right.content.key),e.right.content.value));)e.right.deleted||r.delete(e.right.content.key),e.forward();let s=n.doc,i=s.clientID;r.forEach((o,c)=>{let l=e.left,a=e.right,h=new S(x(i,E(s.store,i)),l,l&&l.lastId,a,a&&a.id,t,null,new C(c,o));h.integrate(n,0),e.right=h,e.forward()})},ce=(n,t)=>{let{key:e,value:r}=t;r===null?n.delete(e):n.set(e,r)},Ni=(n,t)=>{var e;for(;n.right!==null;){if(!(n.right.deleted||n.right.content.constructor===C&&ft((e=t[n.right.content.key])!=null?e:null,n.right.content.value)))break;n.forward()}},Bi=(n,t,e,r)=>{var c;let s=n.doc,i=s.clientID,o=new Map;for(let l in r){let a=r[l],h=(c=e.currentAttributes.get(l))!=null?c:null;if(!ft(h,a)){o.set(l,h);let{left:u,right:d}=e;e.right=new S(x(i,E(s.store,i)),u,u&&u.lastId,d,d&&d.id,t,null,new C(l,a)),e.right.integrate(n,0),e.forward()}}return o},fr=(n,t,e,r,s)=>{e.currentAttributes.forEach((d,f)=>{s[f]===void 0&&(s[f]=null)});let i=n.doc,o=i.clientID;Ni(e,s);let c=Bi(n,t,e,s),l=r.constructor===String?new z(r):r instanceof A?new G(r):new lt(r),{left:a,right:h,index:u}=e;t._searchMarker&&Ie(t._searchMarker,e.index,l.getLength()),h=new S(x(o,E(i.store,o)),a,a&&a.lastId,h,h&&h.id,t,null,l),h.integrate(n,0),e.right=h,e.index=u,e.forward(),Oi(n,t,e,c)},ci=(n,t,e,r,s)=>{let i=n.doc,o=i.clientID;Ni(e,s);let c=Bi(n,t,e,s);t:for(;e.right!==null&&(r>0||c.size>0&&(e.right.deleted||e.right.content.constructor===C));){if(!e.right.deleted)switch(e.right.content.constructor){case C:{let{key:l,value:a}=e.right.content,h=s[l];if(h!==void 0){if(ft(h,a))c.delete(l);else{if(r===0)break t;c.set(l,a)}e.right.delete(n)}else e.currentAttributes.set(l,a);break}default:r<e.right.length&&N(n,x(e.right.id.client,e.right.id.clock+r)),r-=e.right.length;break}e.forward()}if(r>0){let l="";for(;r>0;r--)l+=`
`;e.right=new S(x(o,E(i.store,o)),e.left,e.left&&e.left.lastId,e.right,e.right&&e.right.id,t,null,new z(l)),e.right.integrate(n,0),e.forward()}Oi(n,t,e,c)},Ri=(n,t,e,r,s)=>{var a,h;let i=t,o=T();for(;i&&(!i.countable||i.deleted);){if(!i.deleted&&i.content.constructor===C){let u=i.content;o.set(u.key,u)}i=i.right}let c=0,l=!1;for(;t!==i;){if(e===t&&(l=!0),!t.deleted){let u=t.content;switch(u.constructor){case C:{let{key:d,value:f}=u,g=(a=r.get(d))!=null?a:null;(o.get(d)!==u||g===f)&&(t.delete(n),c++,!l&&((h=s.get(d))!=null?h:null)===f&&g!==f&&(g===null?s.delete(d):s.set(d,g))),!l&&!t.deleted&&ce(s,u);break}}}t=t.right}return c},tl=(n,t)=>{for(;t&&t.right&&(t.right.deleted||!t.right.countable);)t=t.right;let e=new Set;for(;t&&(t.deleted||!t.countable);){if(!t.deleted&&t.content.constructor===C){let r=t.content.key;e.has(r)?t.delete(n):e.add(r)}t=t.left}},el=n=>{let t=0;return k(n.doc,e=>{let r=n._start,s=n._start,i=T(),o=Fe(i);for(;s;){if(s.deleted===!1)switch(s.content.constructor){case C:ce(o,s.content);break;default:t+=Ri(e,r,s,i,o),i=Fe(o),r=s;break}s=s.right}}),t},nl=n=>{let t=new Set,e=n.doc;for(let[r,s]of n.afterState.entries()){let i=n.beforeState.get(r)||0;s!==i&&Si(n,e.store.clients.get(r),i,s,o=>{!o.deleted&&o.content.constructor===C&&o.constructor!==B&&t.add(o.parent)})}k(e,r=>{te(n,n.deleteSet,s=>{if(s instanceof B||!s.parent._hasFormatting||t.has(s.parent))return;let i=s.parent;s.content.constructor===C?t.add(i):tl(r,s)});for(let s of t)el(s)})},li=(n,t,e)=>{let r=e,s=Fe(t.currentAttributes),i=t.right;for(;e>0&&t.right!==null;){if(t.right.deleted===!1)switch(t.right.content.constructor){case G:case lt:case z:e<t.right.length&&N(n,x(t.right.id.client,t.right.id.clock+e)),e-=t.right.length,t.right.delete(n);break}t.forward()}i&&Ri(n,i,t.right,s,t.currentAttributes);let o=(t.left||t.right).parent;return o._searchMarker&&Ie(o._searchMarker,t.index,-r+e),t},Cr=class extends ne{constructor(t,e,r){super(t,e),this.childListChanged=!1,this.keysChanged=new Set,r.forEach(s=>{s===null?this.childListChanged=!0:this.keysChanged.add(s)})}get changes(){if(this._changes===null){let t={keys:this.keys,delta:this.delta,added:new Set,deleted:new Set};this._changes=t}return this._changes}get delta(){if(this._delta===null){let t=this.target.doc,e=[];k(t,r=>{var f,g,b;let s=new Map,i=new Map,o=this.target._start,c=null,l={},a="",h=0,u=0,d=()=>{if(c!==null){let p=null;switch(c){case"delete":u>0&&(p={delete:u}),u=0;break;case"insert":(typeof a=="object"||a.length>0)&&(p={insert:a},s.size>0&&(p.attributes={},s.forEach((y,v)=>{y!==null&&(p.attributes[v]=y)}))),a="";break;case"retain":h>0&&(p={retain:h},Cs(l)||(p.attributes=ks({},l))),h=0;break}p&&e.push(p),c=null}};for(;o!==null;){switch(o.content.constructor){case G:case lt:this.adds(o)?this.deletes(o)||(d(),c="insert",a=o.content.getContent()[0],d()):this.deletes(o)?(c!=="delete"&&(d(),c="delete"),u+=1):o.deleted||(c!=="retain"&&(d(),c="retain"),h+=1);break;case z:this.adds(o)?this.deletes(o)||(c!=="insert"&&(d(),c="insert"),a+=o.content.str):this.deletes(o)?(c!=="delete"&&(d(),c="delete"),u+=o.length):o.deleted||(c!=="retain"&&(d(),c="retain"),h+=o.length);break;case C:{let{key:p,value:y}=o.content;if(this.adds(o)){if(!this.deletes(o)){let v=(f=s.get(p))!=null?f:null;ft(v,y)?y!==null&&o.delete(r):(c==="retain"&&d(),ft(y,(g=i.get(p))!=null?g:null)?delete l[p]:l[p]=y)}}else if(this.deletes(o)){i.set(p,y);let v=(b=s.get(p))!=null?b:null;ft(v,y)||(c==="retain"&&d(),l[p]=v)}else if(!o.deleted){i.set(p,y);let v=l[p];v!==void 0&&(ft(v,y)?v!==null&&o.delete(r):(c==="retain"&&d(),y===null?delete l[p]:l[p]=y))}o.deleted||(c==="insert"&&d(),ce(s,o.content));break}}o=o.right}for(d();e.length>0;){let p=e[e.length-1];if(p.retain!==void 0&&p.attributes===void 0)e.pop();else break}}),this._delta=e}return this._delta}},bt=class extends A{constructor(t){super(),this._pending=t!==void 0?[()=>this.insert(0,t)]:[],this._searchMarker=[],this._hasFormatting=!1}get length(){var t;return(t=this.doc)!=null||M(),this._length}_integrate(t,e){super._integrate(t,e);try{this._pending.forEach(r=>r())}catch(r){console.error(r)}this._pending=null}_copy(){return new bt}clone(){let t=new bt;return t.applyDelta(this.toDelta()),t}_callObserver(t,e){super._callObserver(t,e);let r=new Cr(this,t,e);kn(this,t,r),!t.local&&this._hasFormatting&&(t._needFormattingCleanup=!0)}toString(){var r;(r=this.doc)!=null||M();let t="",e=this._start;for(;e!==null;)!e.deleted&&e.countable&&e.content.constructor===z&&(t+=e.content.str),e=e.right;return t}toJSON(){return this.toString()}applyDelta(t,{sanitize:e=!0}={}){this.doc!==null?k(this.doc,r=>{let s=new Ve(null,this._start,0,new Map);for(let i=0;i<t.length;i++){let o=t[i];if(o.insert!==void 0){let c=!e&&typeof o.insert=="string"&&i===t.length-1&&s.right===null&&o.insert.slice(-1)===`
`?o.insert.slice(0,-1):o.insert;(typeof c!="string"||c.length>0)&&fr(r,this,s,c,o.attributes||{})}else o.retain!==void 0?ci(r,this,s,o.retain,o.attributes||{}):o.delete!==void 0&&li(r,s,o.delete)}}):this._pending.push(()=>this.applyDelta(t))}toDelta(t,e,r){var u;(u=this.doc)!=null||M();let s=[],i=new Map,o=this.doc,c="",l=this._start;function a(){if(c.length>0){let d={},f=!1;i.forEach((b,p)=>{f=!0,d[p]=b});let g={insert:c};f&&(g.attributes=d),s.push(g),c=""}}let h=()=>{for(;l!==null;){if(Xt(l,t)||e!==void 0&&Xt(l,e))switch(l.content.constructor){case z:{let d=i.get("ychange");t!==void 0&&!Xt(l,t)?(d===void 0||d.user!==l.id.client||d.type!=="removed")&&(a(),i.set("ychange",r?r("removed",l.id):{type:"removed"})):e!==void 0&&!Xt(l,e)?(d===void 0||d.user!==l.id.client||d.type!=="added")&&(a(),i.set("ychange",r?r("added",l.id):{type:"added"})):d!==void 0&&(a(),i.delete("ychange")),c+=l.content.str;break}case G:case lt:{a();let d={insert:l.content.getContent()[0]};if(i.size>0){let f={};d.attributes=f,i.forEach((g,b)=>{f[b]=g})}s.push(d);break}case C:Xt(l,t)&&(a(),ce(i,l.content));break}l=l.right}a()};return t||e?k(o,d=>{t&&br(d,t),e&&br(d,e),h()},"cleanup"):h(),s}insert(t,e,r){if(e.length<=0)return;let s=this.doc;s!==null?k(s,i=>{let o=on(i,this,t,!r);r||(r={},o.currentAttributes.forEach((c,l)=>{r[l]=c})),fr(i,this,o,e,r)}):this._pending.push(()=>this.insert(t,e,r))}insertEmbed(t,e,r){let s=this.doc;s!==null?k(s,i=>{let o=on(i,this,t,!r);fr(i,this,o,e,r||{})}):this._pending.push(()=>this.insertEmbed(t,e,r||{}))}delete(t,e){if(e===0)return;let r=this.doc;r!==null?k(r,s=>{li(s,on(s,this,t,!0),e)}):this._pending.push(()=>this.delete(t,e))}format(t,e,r){if(e===0)return;let s=this.doc;s!==null?k(s,i=>{let o=on(i,this,t,!1);o.right!==null&&ci(i,this,o,e,r)}):this._pending.push(()=>this.format(t,e,r))}removeAttribute(t){this.doc!==null?k(this.doc,e=>{yn(e,this,t)}):this._pending.push(()=>this.removeAttribute(t))}setAttribute(t,e){this.doc!==null?k(this.doc,r=>{Br(r,this,t,e)}):this._pending.push(()=>this.setAttribute(t,e))}getAttribute(t){return Rr(this,t)}getAttributes(){return Mi(this)}_write(t){t.writeTypeRef(Sl)}},rl=n=>new bt,_e=class{constructor(t,e=()=>!0){var r;this._filter=e,this._root=t,this._currentNode=t._start,this._firstCall=!0,(r=t.doc)!=null||M()}[Symbol.iterator](){return this}next(){let t=this._currentNode,e=t&&t.content&&t.content.type;if(t!==null&&(!this._firstCall||t.deleted||!this._filter(e)))do if(e=t.content.type,!t.deleted&&(e.constructor===xt||e.constructor===ct)&&e._start!==null)t=e._start;else for(;t!==null;){let r=t.next;if(r!==null){t=r;break}else t.parent===this._root?t=null:t=t.parent._item}while(t!==null&&(t.deleted||!this._filter(t.content.type)));return this._firstCall=!1,t===null?{value:void 0,done:!0}:(this._currentNode=t,{value:t.content.type,done:!1})}},ct=class extends A{constructor(){super(),this._prelimContent=[]}get firstChild(){let t=this._first;return t?t.content.getContent()[0]:null}_integrate(t,e){super._integrate(t,e),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new ct}clone(){let t=new ct;return t.insert(0,this.toArray().map(e=>e instanceof A?e.clone():e)),t}get length(){var t;return(t=this.doc)!=null||M(),this._prelimContent===null?this._length:this._prelimContent.length}createTreeWalker(t){return new _e(this,t)}querySelector(t){t=t.toUpperCase();let r=new _e(this,s=>s.nodeName&&s.nodeName.toUpperCase()===t).next();return r.done?null:r.value}querySelectorAll(t){return t=t.toUpperCase(),J(new _e(this,e=>e.nodeName&&e.nodeName.toUpperCase()===t))}_callObserver(t,e){kn(this,t,new Ar(this,e,t))}toString(){return Di(this,t=>t.toString()).join("")}toJSON(){return this.toString()}toDOM(t=document,e={},r){let s=t.createDocumentFragment();return r!==void 0&&r._createAssociation(s,this),Te(this,i=>{s.insertBefore(i.toDOM(t,e,r),null)}),s}insert(t,e){this.doc!==null?k(this.doc,r=>{Vi(r,this,t,e)}):this._prelimContent.splice(t,0,...e)}insertAfter(t,e){if(this.doc!==null)k(this.doc,r=>{let s=t&&t instanceof A?t._item:t;wn(r,this,s,e)});else{let r=this._prelimContent,s=t===null?0:r.findIndex(i=>i===t)+1;if(s===0&&t!==null)throw Q("Reference item not found");r.splice(s,0,...e)}}delete(t,e=1){this.doc!==null?k(this.doc,r=>{vi(r,this,t,e)}):this._prelimContent.splice(t,e)}toArray(){return Ai(this)}push(t){this.insert(this.length,t)}unshift(t){this.insert(0,t)}get(t){return Ii(this,t)}slice(t=0,e=this.length){return Ci(this,t,e)}forEach(t){Te(this,t)}_write(t){t.writeTypeRef(Ul)}},sl=n=>new ct,xt=class extends ct{constructor(t="UNDEFINED"){super(),this.nodeName=t,this._prelimAttrs=new Map}get nextSibling(){let t=this._item?this._item.next:null;return t?t.content.type:null}get prevSibling(){let t=this._item?this._item.prev:null;return t?t.content.type:null}_integrate(t,e){super._integrate(t,e),this._prelimAttrs.forEach((r,s)=>{this.setAttribute(s,r)}),this._prelimAttrs=null}_copy(){return new xt(this.nodeName)}clone(){let t=new xt(this.nodeName),e=this.getAttributes();return _s(e,(r,s)=>{typeof r=="string"&&t.setAttribute(s,r)}),t.insert(0,this.toArray().map(r=>r instanceof A?r.clone():r)),t}toString(){let t=this.getAttributes(),e=[],r=[];for(let c in t)r.push(c);r.sort();let s=r.length;for(let c=0;c<s;c++){let l=r[c];e.push(l+'="'+t[l]+'"')}let i=this.nodeName.toLocaleLowerCase(),o=e.length>0?" "+e.join(" "):"";return`<${i}${o}>${super.toString()}</${i}>`}removeAttribute(t){this.doc!==null?k(this.doc,e=>{yn(e,this,t)}):this._prelimAttrs.delete(t)}setAttribute(t,e){this.doc!==null?k(this.doc,r=>{Br(r,this,t,e)}):this._prelimAttrs.set(t,e)}getAttribute(t){return Rr(this,t)}hasAttribute(t){return Li(this,t)}getAttributes(t){return t?Xc(this,t):Mi(this)}toDOM(t=document,e={},r){let s=t.createElement(this.nodeName),i=this.getAttributes();for(let o in i){let c=i[o];typeof c=="string"&&s.setAttribute(o,c)}return Te(this,o=>{s.appendChild(o.toDOM(t,e,r))}),r!==void 0&&r._createAssociation(s,this),s}_write(t){t.writeTypeRef(kl),t.writeKey(this.nodeName)}},il=n=>new xt(n.readKey()),Ar=class extends ne{constructor(t,e,r){super(t,r),this.childListChanged=!1,this.attributesChanged=new Set,e.forEach(s=>{s===null?this.childListChanged=!0:this.attributesChanged.add(s)})}},re=class extends yt{constructor(t){super(),this.hookName=t}_copy(){return new re(this.hookName)}clone(){let t=new re(this.hookName);return this.forEach((e,r)=>{t.set(r,e)}),t}toDOM(t=document,e={},r){let s=e[this.hookName],i;return s!==void 0?i=s.createDom(this):i=document.createElement(this.hookName),i.setAttribute("data-yjs-hook",this.hookName),r!==void 0&&r._createAssociation(i,this),i}_write(t){t.writeTypeRef(_l),t.writeKey(this.hookName)}},ol=n=>new re(n.readKey()),se=class extends bt{get nextSibling(){let t=this._item?this._item.next:null;return t?t.content.type:null}get prevSibling(){let t=this._item?this._item.prev:null;return t?t.content.type:null}_copy(){return new se}clone(){let t=new se;return t.applyDelta(this.toDelta()),t}toDOM(t=document,e,r){let s=t.createTextNode(this.toString());return r!==void 0&&r._createAssociation(s,this),s}toString(){return this.toDelta().map(t=>{let e=[];for(let s in t.attributes){let i=[];for(let o in t.attributes[s])i.push({key:o,value:t.attributes[s][o]});i.sort((o,c)=>o.key<c.key?-1:1),e.push({nodeName:s,attrs:i})}e.sort((s,i)=>s.nodeName<i.nodeName?-1:1);let r="";for(let s=0;s<e.length;s++){let i=e[s];r+=`<${i.nodeName}`;for(let o=0;o<i.attrs.length;o++){let c=i.attrs[o];r+=` ${c.key}="${c.value}"`}r+=">"}r+=t.insert;for(let s=e.length-1;s>=0;s--)r+=`</${e[s].nodeName}>`;return r}).join("")}toJSON(){return this.toString()}_write(t){t.writeTypeRef(El)}},cl=n=>new se,ve=class{constructor(t,e){this.id=t,this.length=e}get deleted(){throw W()}mergeWith(t){return!1}write(t,e,r){throw W()}integrate(t,e){throw W()}},ll=0,B=class extends ve{get deleted(){return!0}delete(){}mergeWith(t){return this.constructor!==t.constructor?!1:(this.length+=t.length,!0)}integrate(t,e){e>0&&(this.id.clock+=e,this.length-=e),xi(t.doc.store,this)}write(t,e){t.writeInfo(ll),t.writeLen(this.length-e)}getMissing(t,e){return null}},Tt=class{constructor(t){this.content=t}getLength(){return 1}getContent(){return[this.content]}isCountable(){return!0}copy(){return new Tt(this.content)}splice(t){throw W()}mergeWith(t){return!1}integrate(t,e){}delete(t){}gc(t){}write(t,e){t.writeBuf(this.content)}getRef(){return 3}},al=n=>new Tt(n.readBuf()),Vt=class{constructor(t){this.len=t}getLength(){return this.len}getContent(){return[]}isCountable(){return!1}copy(){return new Vt(this.len)}splice(t){let e=new Vt(this.len-t);return this.len=t,e}mergeWith(t){return this.len+=t.len,!0}integrate(t,e){Ce(t.deleteSet,e.id.client,e.id.clock,this.len),e.markDeleted()}delete(t){}gc(t){}write(t,e){t.writeLen(this.len-e)}getRef(){return 1}},hl=n=>new Vt(n.readLen()),Fi=(n,t)=>new nt({guid:n,...t,shouldLoad:t.shouldLoad||t.autoLoad||!1}),vt=class{constructor(t){t._item&&console.error("This document was already integrated as a sub-document. You should create a second instance instead with the same guid."),this.doc=t;let e={};this.opts=e,t.gc||(e.gc=!1),t.autoLoad&&(e.autoLoad=!0),t.meta!==null&&(e.meta=t.meta)}getLength(){return 1}getContent(){return[this.doc]}isCountable(){return!0}copy(){return new vt(Fi(this.doc.guid,this.opts))}splice(t){throw W()}mergeWith(t){return!1}integrate(t,e){this.doc._item=e,t.subdocsAdded.add(this.doc),this.doc.shouldLoad&&t.subdocsLoaded.add(this.doc)}delete(t){t.subdocsAdded.has(this.doc)?t.subdocsAdded.delete(this.doc):t.subdocsRemoved.add(this.doc)}gc(t){}write(t,e){t.writeString(this.doc.guid),t.writeAny(this.opts)}getRef(){return 9}},dl=n=>new vt(Fi(n.readString(),n.readAny())),lt=class{constructor(t){this.embed=t}getLength(){return 1}getContent(){return[this.embed]}isCountable(){return!0}copy(){return new lt(this.embed)}splice(t){throw W()}mergeWith(t){return!1}integrate(t,e){}delete(t){}gc(t){}write(t,e){t.writeJSON(this.embed)}getRef(){return 5}},ul=n=>new lt(n.readJSON()),C=class{constructor(t,e){this.key=t,this.value=e}getLength(){return 1}getContent(){return[]}isCountable(){return!1}copy(){return new C(this.key,this.value)}splice(t){throw W()}mergeWith(t){return!1}integrate(t,e){let r=e.parent;r._searchMarker=null,r._hasFormatting=!0}delete(t){}gc(t){}write(t,e){t.writeKey(this.key),t.writeJSON(this.value)}getRef(){return 6}},fl=n=>new C(n.readKey(),n.readJSON()),ie=class{constructor(t){this.arr=t}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new ie(this.arr)}splice(t){let e=new ie(this.arr.slice(t));return this.arr=this.arr.slice(0,t),e}mergeWith(t){return this.arr=this.arr.concat(t.arr),!0}integrate(t,e){}delete(t){}gc(t){}write(t,e){let r=this.arr.length;t.writeLen(r-e);for(let s=e;s<r;s++){let i=this.arr[s];t.writeString(i===void 0?"undefined":JSON.stringify(i))}}getRef(){return 2}},gl=n=>{let t=n.readLen(),e=[];for(let r=0;r<t;r++){let s=n.readString();s==="undefined"?e.push(void 0):e.push(JSON.parse(s))}return new ie(e)},pl=be("node_env")==="development",at=class{constructor(t){this.arr=t,pl&&tr(t)}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new at(this.arr)}splice(t){let e=new at(this.arr.slice(t));return this.arr=this.arr.slice(0,t),e}mergeWith(t){return this.arr=this.arr.concat(t.arr),!0}integrate(t,e){}delete(t){}gc(t){}write(t,e){let r=this.arr.length;t.writeLen(r-e);for(let s=e;s<r;s++){let i=this.arr[s];t.writeAny(i)}}getRef(){return 8}},ml=n=>{let t=n.readLen(),e=[];for(let r=0;r<t;r++)e.push(n.readAny());return new at(e)},z=class{constructor(t){this.str=t}getLength(){return this.str.length}getContent(){return this.str.split("")}isCountable(){return!0}copy(){return new z(this.str)}splice(t){let e=new z(this.str.slice(t));this.str=this.str.slice(0,t);let r=this.str.charCodeAt(t-1);return r>=55296&&r<=56319&&(this.str=this.str.slice(0,t-1)+"\uFFFD",e.str="\uFFFD"+e.str.slice(1)),e}mergeWith(t){return this.str+=t.str,!0}integrate(t,e){}delete(t){}gc(t){}write(t,e){t.writeString(e===0?this.str:this.str.slice(e))}getRef(){return 4}},wl=n=>new z(n.readString()),yl=[Qc,Zc,rl,il,sl,ol,cl],bl=0,xl=1,Sl=2,kl=3,Ul=4,_l=5,El=6,G=class{constructor(t){this.type=t}getLength(){return 1}getContent(){return[this.type]}isCountable(){return!0}copy(){return new G(this.type._copy())}splice(t){throw W()}mergeWith(t){return!1}integrate(t,e){this.type._integrate(t.doc,e)}delete(t){let e=this.type._start;for(;e!==null;)e.deleted?e.id.clock<(t.beforeState.get(e.id.client)||0)&&t._mergeStructs.push(e):e.delete(t),e=e.right;this.type._map.forEach(r=>{r.deleted?r.id.clock<(t.beforeState.get(r.id.client)||0)&&t._mergeStructs.push(r):r.delete(t)}),t.changed.delete(this.type)}gc(t){let e=this.type._start;for(;e!==null;)e.gc(t,!0),e=e.right;this.type._start=null,this.type._map.forEach(r=>{for(;r!==null;)r.gc(t,!0),r=r.left}),this.type._map=new Map}write(t,e){this.type._write(t)}getRef(){return 7}},Cl=n=>new G(yl[n.readTypeRef()](n)),Dr=(n,t)=>{let e=t,r=0,s;do r>0&&(e=x(e.client,e.clock+r)),s=Zt(n,e),r=e.clock-s.id.clock,e=s.redone;while(e!==null&&s instanceof S);return{item:s,diff:r}},Fr=(n,t)=>{for(;n!==null&&n.keep!==t;)n.keep=t,n=n.parent._item},bn=(n,t,e)=>{let{client:r,clock:s}=t.id,i=new S(x(r,s+e),t,x(r,s+e-1),t.right,t.rightOrigin,t.parent,t.parentSub,t.content.splice(e));return t.deleted&&i.markDeleted(),t.keep&&(i.keep=!0),t.redone!==null&&(i.redone=x(t.redone.client,t.redone.clock+e)),t.right=i,i.right!==null&&(i.right.left=i),n._mergeStructs.push(i),i.parentSub!==null&&i.right===null&&i.parent._map.set(i.parentSub,i),t.length=e,i},ai=(n,t)=>ns(n,e=>Me(e.deletions,t)),Pi=(n,t,e,r,s,i)=>{let o=n.doc,c=o.store,l=o.clientID,a=t.redone;if(a!==null)return N(n,a);let h=t.parent._item,u=null,d;if(h!==null&&h.deleted===!0){if(h.redone===null&&(!e.has(h)||Pi(n,h,e,r,s,i)===null))return null;for(;h.redone!==null;)h=N(n,h.redone)}let f=h===null?t.parent:h.content.type;if(t.parentSub===null){for(u=t.left,d=t;u!==null;){let y=u;for(;y!==null&&y.parent._item!==h;)y=y.redone===null?null:N(n,y.redone);if(y!==null&&y.parent._item===h){u=y;break}u=u.left}for(;d!==null;){let y=d;for(;y!==null&&y.parent._item!==h;)y=y.redone===null?null:N(n,y.redone);if(y!==null&&y.parent._item===h){d=y;break}d=d.right}}else if(d=null,t.right&&!s){for(u=t;u!==null&&u.right!==null&&(u.right.redone||Me(r,u.right.id)||ai(i.undoStack,u.right.id)||ai(i.redoStack,u.right.id));)for(u=u.right;u.redone;)u=N(n,u.redone);if(u&&u.right!==null)return null}else u=f._map.get(t.parentSub)||null;let g=E(c,l),b=x(l,g),p=new S(b,u,u&&u.lastId,d,d&&d.id,f,t.parentSub,t.content.copy());return t.redone=b,Fr(p,!0),p.integrate(n,0),p},S=class extends ve{constructor(t,e,r,s,i,o,c,l){super(t,l.getLength()),this.origin=r,this.left=e,this.right=s,this.rightOrigin=i,this.parent=o,this.parentSub=c,this.redone=null,this.content=l,this.info=this.content.isCountable()?2:0}set marker(t){(this.info&8)>0!==t&&(this.info^=8)}get marker(){return(this.info&8)>0}get keep(){return(this.info&1)>0}set keep(t){this.keep!==t&&(this.info^=1)}get countable(){return(this.info&2)>0}get deleted(){return(this.info&4)>0}set deleted(t){this.deleted!==t&&(this.info^=4)}markDeleted(){this.info|=4}getMissing(t,e){if(this.origin&&this.origin.client!==this.id.client&&this.origin.clock>=E(e,this.origin.client))return this.origin.client;if(this.rightOrigin&&this.rightOrigin.client!==this.id.client&&this.rightOrigin.clock>=E(e,this.rightOrigin.client))return this.rightOrigin.client;if(this.parent&&this.parent.constructor===gt&&this.id.client!==this.parent.client&&this.parent.clock>=E(e,this.parent.client))return this.parent.client;if(this.origin&&(this.left=ti(t,e,this.origin),this.origin=this.left.lastId),this.rightOrigin&&(this.right=N(t,this.rightOrigin),this.rightOrigin=this.right.id),this.left&&this.left.constructor===B||this.right&&this.right.constructor===B)this.parent=null;else if(!this.parent)this.left&&this.left.constructor===S?(this.parent=this.left.parent,this.parentSub=this.left.parentSub):this.right&&this.right.constructor===S&&(this.parent=this.right.parent,this.parentSub=this.right.parentSub);else if(this.parent.constructor===gt){let r=Zt(e,this.parent);r.constructor===B?this.parent=null:this.parent=r.content.type}return null}integrate(t,e){if(e>0&&(this.id.clock+=e,this.left=ti(t,t.doc.store,x(this.id.client,this.id.clock-1)),this.origin=this.left.lastId,this.content=this.content.splice(e),this.length-=e),this.parent){if(!this.left&&(!this.right||this.right.left!==null)||this.left&&this.left.right!==this.right){let r=this.left,s;if(r!==null)s=r.right;else if(this.parentSub!==null)for(s=this.parent._map.get(this.parentSub)||null;s!==null&&s.left!==null;)s=s.left;else s=this.parent._start;let i=new Set,o=new Set;for(;s!==null&&s!==this.right;){if(o.add(s),i.add(s),Qt(this.origin,s.origin)){if(s.id.client<this.id.client)r=s,i.clear();else if(Qt(this.rightOrigin,s.rightOrigin))break}else if(s.origin!==null&&o.has(Zt(t.doc.store,s.origin)))i.has(Zt(t.doc.store,s.origin))||(r=s,i.clear());else break;s=s.right}this.left=r}if(this.left!==null){let r=this.left.right;this.right=r,this.left.right=this}else{let r;if(this.parentSub!==null)for(r=this.parent._map.get(this.parentSub)||null;r!==null&&r.left!==null;)r=r.left;else r=this.parent._start,this.parent._start=this;this.right=r}this.right!==null?this.right.left=this:this.parentSub!==null&&(this.parent._map.set(this.parentSub,this),this.left!==null&&this.left.delete(t)),this.parentSub===null&&this.countable&&!this.deleted&&(this.parent._length+=this.length),xi(t.doc.store,this),this.content.integrate(t,this),ni(t,this.parent,this.parentSub),(this.parent._item!==null&&this.parent._item.deleted||this.parentSub!==null&&this.right!==null)&&this.delete(t)}else new B(this.id,this.length).integrate(t,0)}get next(){let t=this.right;for(;t!==null&&t.deleted;)t=t.right;return t}get prev(){let t=this.left;for(;t!==null&&t.deleted;)t=t.left;return t}get lastId(){return this.length===1?this.id:x(this.id.client,this.id.clock+this.length-1)}mergeWith(t){if(this.constructor===t.constructor&&Qt(t.origin,this.lastId)&&this.right===t&&Qt(this.rightOrigin,t.rightOrigin)&&this.id.client===t.id.client&&this.id.clock+this.length===t.id.clock&&this.deleted===t.deleted&&this.redone===null&&t.redone===null&&this.content.constructor===t.content.constructor&&this.content.mergeWith(t.content)){let e=this.parent._searchMarker;return e&&e.forEach(r=>{r.p===t&&(r.p=this,!this.deleted&&this.countable&&(r.index-=this.length))}),t.keep&&(this.keep=!0),this.right=t.right,this.right!==null&&(this.right.left=this),this.length+=t.length,!0}return!1}delete(t){if(!this.deleted){let e=this.parent;this.countable&&this.parentSub===null&&(e._length-=this.length),this.markDeleted(),Ce(t.deleteSet,this.id.client,this.id.clock,this.length),ni(t,e,this.parentSub),this.content.delete(t)}}gc(t,e){if(!this.deleted)throw $();this.content.gc(t),e?Bc(t,this,new B(this.id,this.length)):this.content=new Vt(this.length)}write(t,e){let r=e>0?x(this.id.client,this.id.clock+e-1):this.origin,s=this.rightOrigin,i=this.parentSub,o=this.content.getRef()&31|(r===null?0:128)|(s===null?0:64)|(i===null?0:32);if(t.writeInfo(o),r!==null&&t.writeLeftID(r),s!==null&&t.writeRightID(s),r===null&&s===null){let c=this.parent;if(c._item!==void 0){let l=c._item;if(l===null){let a=bi(c);t.writeParentInfo(!0),t.writeString(a)}else t.writeParentInfo(!1),t.writeLeftID(l.id)}else c.constructor===String?(t.writeParentInfo(!0),t.writeString(c)):c.constructor===gt?(t.writeParentInfo(!1),t.writeLeftID(c)):$();i!==null&&t.writeString(i)}this.content.write(t,e)}},ji=(n,t)=>Al[t&31](n),Al=[()=>{$()},hl,gl,al,wl,ul,fl,Cl,ml,dl,()=>{$()}],Dl=10,R=class extends ve{get deleted(){return!0}delete(){}mergeWith(t){return this.constructor!==t.constructor?!1:(this.length+=t.length,!0)}integrate(t,e){$()}write(t,e){t.writeInfo(Dl),m(t.restEncoder,this.length-e)}getMissing(t,e){return null}},Hi=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:{},Yi="__ $YJS$ __";Hi[Yi]===!0&&console.error("Yjs was already imported. This breaks constructor checks and will lead to issues! - https://github.com/yjs/yjs/issues/438");Hi[Yi]=!0;var $i=new Map,Pr=class{constructor(t){this.room=t,this.onmessage=null,this._onChange=e=>e.key===t&&this.onmessage!==null&&this.onmessage({data:Ls(e.newValue||"")}),ys(this._onChange)}postMessage(t){Ze.setItem(this.room,Ms(vs(t)))}close(){bs(this._onChange)}},Il=typeof BroadcastChannel=="undefined"?Pr:BroadcastChannel,jr=n=>F($i,n,()=>{let t=H(),e=new Il(n);return e.onmessage=r=>t.forEach(s=>s(r.data,"broadcastchannel")),{bc:e,subs:t}}),zi=(n,t)=>(jr(n).subs.add(t),t),Gi=(n,t)=>{let e=jr(n),r=e.subs.delete(t);return r&&e.subs.size===0&&(e.bc.close(),$i.delete(n)),r},Mt=(n,t,e=null)=>{let r=jr(n);r.bc.postMessage(t),r.subs.forEach(s=>s(t,e))};var Ji=0,Un=1,qi=2,_n=(n,t)=>{m(n,Ji);let e=wi(t);_(n,e)},Hr=(n,t,e)=>{m(n,Un),_(n,gi(t,e))},Vl=(n,t,e)=>Hr(t,e,I(n)),Wi=(n,t,e)=>{try{fi(t,I(n),e)}catch(r){console.error("Caught error while handling a Yjs update",r)}},Ki=(n,t)=>{m(n,qi),_(n,t)},vl=Wi,Xi=(n,t,e,r)=>{let s=w(n);switch(s){case Ji:Vl(n,t,e);break;case Un:Wi(n,e,r);break;case qi:vl(n,e,r);break;default:throw new Error("Unknown message type")}return s};var Ll=0;var Qi=(n,t,e)=>{switch(w(n)){case Ll:e(t,K(n))}};var Yr=3e4,En=class extends He{constructor(t){super(),this.doc=t,this.clientID=t.clientID,this.states=new Map,this.meta=new Map,this._checkInterval=setInterval(()=>{let e=P();this.getLocalState()!==null&&Yr/2<=e-this.meta.get(this.clientID).lastUpdated&&this.setLocalState(this.getLocalState());let r=[];this.meta.forEach((s,i)=>{i!==this.clientID&&Yr<=e-s.lastUpdated&&this.states.has(i)&&r.push(i)}),r.length>0&&Cn(this,r,"timeout")},O(Yr/10)),t.on("destroy",()=>{this.destroy()}),this.setLocalState({})}destroy(){this.emit("destroy",[this]),this.setLocalState(null),super.destroy(),clearInterval(this._checkInterval)}getLocalState(){return this.states.get(this.clientID)||null}setLocalState(t){let e=this.clientID,r=this.meta.get(e),s=r===void 0?0:r.clock+1,i=this.states.get(e);t===null?this.states.delete(e):this.states.set(e,t),this.meta.set(e,{clock:s,lastUpdated:P()});let o=[],c=[],l=[],a=[];t===null?a.push(e):i==null?t!=null&&o.push(e):(c.push(e),qt(i,t)||l.push(e)),(o.length>0||l.length>0||a.length>0)&&this.emit("change",[{added:o,updated:l,removed:a},"local"]),this.emit("update",[{added:o,updated:c,removed:a},"local"])}setLocalStateField(t,e){let r=this.getLocalState();r!==null&&this.setLocalState({...r,[t]:e})}getStates(){return this.states}},Cn=(n,t,e)=>{let r=[];for(let s=0;s<t.length;s++){let i=t[s];if(n.states.has(i)){if(n.states.delete(i),i===n.clientID){let o=n.meta.get(i);n.meta.set(i,{clock:o.clock+1,lastUpdated:P()})}r.push(i)}}r.length>0&&(n.emit("change",[{added:[],updated:[],removed:r},e]),n.emit("update",[{added:[],updated:[],removed:r},e]))},ae=(n,t,e=n.states)=>{let r=t.length,s=D();m(s,r);for(let i=0;i<r;i++){let o=t[i],c=e.get(o)||null,l=n.meta.get(o).clock;m(s,o),m(s,l),st(s,JSON.stringify(c))}return U(s)};var Zi=(n,t,e)=>{let r=X(t),s=P(),i=[],o=[],c=[],l=[],a=w(r);for(let h=0;h<a;h++){let u=w(r),d=w(r),f=JSON.parse(K(r)),g=n.meta.get(u),b=n.states.get(u),p=g===void 0?0:g.clock;(p<d||p===d&&f===null&&n.states.has(u))&&(f===null?u===n.clientID&&n.getLocalState()!=null?d++:n.states.delete(u):n.states.set(u,f),n.meta.set(u,{clock:d,lastUpdated:s}),g===void 0&&f!==null?i.push(u):g!==void 0&&f===null?l.push(u):f!==null&&(qt(f,b)||c.push(u),o.push(u)))}(i.length>0||c.length>0||l.length>0)&&n.emit("change",[{added:i,updated:c,removed:l},e]),(i.length>0||o.length>0||l.length>0)&&n.emit("update",[{added:i,updated:o,removed:l},e])};var to=n=>Es(n,(t,e)=>`${encodeURIComponent(e)}=${encodeURIComponent(t)}`).join("&");var Lt=0,no=3,he=1,Rl=2,Ne=[];Ne[Lt]=(n,t,e,r,s)=>{m(n,Lt);let i=Xi(t,n,e.doc,e);r&&i===Un&&!e.synced&&(e.synced=!0)};Ne[no]=(n,t,e,r,s)=>{m(n,he),_(n,ae(e.awareness,Array.from(e.awareness.getStates().keys())))};Ne[he]=(n,t,e,r,s)=>{Zi(e.awareness,I(t),e)};Ne[Rl]=(n,t,e,r,s)=>{Qi(t,e.doc,(i,o)=>Fl(e,o))};var eo=3e4,Fl=(n,t)=>console.warn(`Permission denied to access ${n.url}.
${t}`),ro=(n,t,e)=>{let r=X(t),s=D(),i=w(r),o=n.messageHandlers[i];return o?o(s,r,n,e,i):console.error("Unable to compute message"),s},zr=(n,t,e)=>{t===n.ws&&(n.emit("connection-close",[e,n]),n.ws=null,t.close(),n.wsconnecting=!1,n.wsconnected?(n.wsconnected=!1,n.synced=!1,Cn(n.awareness,Array.from(n.awareness.getStates().keys()).filter(r=>r!==n.doc.clientID),n),n.emit("status",[{status:"disconnected"}])):n.wsUnsuccessfulReconnects++,setTimeout(so,ht(rs(2,n.wsUnsuccessfulReconnects)*100,n.maxBackoffTime),n))},so=n=>{if(n.shouldConnect&&n.ws===null){let t=new n._WS(n.url,n.protocols);t.binaryType="arraybuffer",n.ws=t,n.wsconnecting=!0,n.wsconnected=!1,n.synced=!1,t.onmessage=e=>{n.wsLastMessageReceived=P();let r=ro(n,new Uint8Array(e.data),!0);Ge(r)>1&&t.send(U(r))},t.onerror=e=>{n.emit("connection-error",[e,n])},t.onclose=e=>{zr(n,t,e)},t.onopen=()=>{n.wsLastMessageReceived=P(),n.wsconnecting=!1,n.wsconnected=!0,n.wsUnsuccessfulReconnects=0,n.emit("status",[{status:"connected"}]);let e=D();if(m(e,Lt),_n(e,n.doc),t.send(U(e)),n.awareness.getLocalState()!==null){let r=D();m(r,he),_(r,ae(n.awareness,[n.doc.clientID])),t.send(U(r))}},n.emit("status",[{status:"connecting"}])}},$r=(n,t)=>{let e=n.ws;n.wsconnected&&e&&e.readyState===e.OPEN&&e.send(t),n.bcconnected&&Mt(n.bcChannel,t,n)},An=class extends Ut{constructor(t,e,r,{connect:s=!0,awareness:i=new En(r),params:o={},protocols:c=[],WebSocketPolyfill:l=WebSocket,resyncInterval:a=-1,maxBackoffTime:h=2500,disableBc:u=!1}={}){for(super();t[t.length-1]==="/";)t=t.slice(0,t.length-1);this.serverUrl=t,this.bcChannel=t+"/"+e,this.maxBackoffTime=h,this.params=o,this.protocols=c,this.roomname=e,this.doc=r,this._WS=l,this.awareness=i,this.wsconnected=!1,this.wsconnecting=!1,this.bcconnected=!1,this.disableBc=u,this.wsUnsuccessfulReconnects=0,this.messageHandlers=Ne.slice(),this._synced=!1,this.ws=null,this.wsLastMessageReceived=0,this.shouldConnect=s,this._resyncInterval=0,a>0&&(this._resyncInterval=setInterval(()=>{if(this.ws&&this.ws.readyState===WebSocket.OPEN){let d=D();m(d,Lt),_n(d,r),this.ws.send(U(d))}},a)),this._bcSubscriber=(d,f)=>{if(f!==this){let g=ro(this,new Uint8Array(d),!1);Ge(g)>1&&Mt(this.bcChannel,U(g),this)}},this._updateHandler=(d,f)=>{if(f!==this){let g=D();m(g,Lt),Ki(g,d),$r(this,U(g))}},this.doc.on("update",this._updateHandler),this._awarenessUpdateHandler=({added:d,updated:f,removed:g},b)=>{let p=d.concat(f).concat(g),y=D();m(y,he),_(y,ae(i,p)),$r(this,U(y))},this._exitHandler=()=>{Cn(this.awareness,[r.clientID],"app closed")},it&&typeof process!="undefined"&&process.on("exit",this._exitHandler),i.on("update",this._awarenessUpdateHandler),this._checkInterval=setInterval(()=>{this.wsconnected&&eo<P()-this.wsLastMessageReceived&&zr(this,this.ws,null)},eo/10),s&&this.connect()}get url(){let t=to(this.params);return this.serverUrl+"/"+this.roomname+(t.length===0?"":"?"+t)}get synced(){return this._synced}set synced(t){this._synced!==t&&(this._synced=t,this.emit("synced",[t]),this.emit("sync",[t]))}destroy(){this._resyncInterval!==0&&clearInterval(this._resyncInterval),clearInterval(this._checkInterval),this.disconnect(),it&&typeof process!="undefined"&&process.off("exit",this._exitHandler),this.awareness.off("update",this._awarenessUpdateHandler),this.doc.off("update",this._updateHandler),super.destroy()}connectBc(){if(this.disableBc)return;this.bcconnected||(zi(this.bcChannel,this._bcSubscriber),this.bcconnected=!0);let t=D();m(t,Lt),_n(t,this.doc),Mt(this.bcChannel,U(t),this);let e=D();m(e,Lt),Hr(e,this.doc),Mt(this.bcChannel,U(e),this);let r=D();m(r,no),Mt(this.bcChannel,U(r),this);let s=D();m(s,he),_(s,ae(this.awareness,[this.doc.clientID])),Mt(this.bcChannel,U(s),this)}disconnectBc(){let t=D();m(t,he),_(t,ae(this.awareness,[this.doc.clientID],new Map)),$r(this,U(t)),this.bcconnected&&(Gi(this.bcChannel,this._bcSubscriber),this.bcconnected=!1)}disconnect(){this.shouldConnect=!1,this.disconnectBc(),this.ws!==null&&zr(this,this.ws,null)}connect(){this.shouldConnect=!0,!this.wsconnected&&this.ws===null&&(so(this),this.connectBc())}};var Dn=class{constructor(t,e,r){this.app=t;this.serverUrl=e;this.username=r;this.sessions=new Map}async createSession(t){let e=this.getRoomName(t),r=new nt,s=r.getText("content"),i=new An(this.serverUrl,e,r);if(i.awareness.setLocalStateField("user",{name:this.username,color:this.generateColor()}),await new Promise(c=>{i.once("sync",()=>c())}),s.length===0){let c=await this.app.vault.read(t);s.insert(0,c)}let o={doc:r,provider:i,ytext:s,file:t};return this.sessions.set(t.path,o),o}destroySession(t){let e=this.sessions.get(t.path);e&&(e.provider.destroy(),e.doc.destroy(),this.sessions.delete(t.path))}getSession(t){return this.sessions.get(t.path)||null}destroyAll(){for(let t of this.sessions.values())t.provider.destroy(),t.doc.destroy();this.sessions.clear()}getRoomName(t){return`vault:///${t.path}`}generateColor(){let t=["#FF6B6B","#4ECDC4","#45B7D1","#FFA07A","#98D8C8","#F06292","#BA68C8","#4DB6AC"];return t[Math.floor(Math.random()*t.length)]}};var wo=require("obsidian");var mo=require("@codemirror/state");var go=kt(require("@codemirror/view"),1),Ra=require("@codemirror/state");var de=class{constructor(t,e){this.yanchor=t,this.yhead=e}toJSON(){return{yanchor:Mr(this.yanchor),yhead:Mr(this.yhead)}}static fromJSON(t){return new de(St(t.yanchor),St(t.yhead))}};var Ot=kt(require("@codemirror/state"),1),io=kt(require("@codemirror/view"),1);var In=class{constructor(t,e){this.ytext=t,this.awareness=e,this.undoManager=new ee(t)}toYPos(t,e=0){return Le(this.ytext,t,e)}fromYPos(t){let e=Oe(St(t),this.ytext.doc);if(e==null||e.type!==this.ytext)throw new Error("[y-codemirror] The position you want to retrieve was created by a different document");return{pos:e.index,assoc:e.assoc}}toYRange(t){let e=t.assoc,r=this.toYPos(t.anchor,e),s=this.toYPos(t.head,e);return new de(r,s)}fromYRange(t){let e=this.fromYPos(t.yanchor),r=this.fromYPos(t.yhead);return e.pos===r.pos?Ot.EditorSelection.cursor(r.pos,r.assoc):Ot.EditorSelection.range(e.pos,r.pos)}},Nt=Ot.Facet.define({combine(n){return n[n.length-1]}}),Tn=Ot.Annotation.define(),Gr=class{constructor(t){this.view=t,this.conf=t.state.facet(Nt),this._observer=(e,r)=>{if(r.origin!==this.conf){let s=e.delta,i=[],o=0;for(let c=0;c<s.length;c++){let l=s[c];l.insert!=null?i.push({from:o,to:o,insert:l.insert}):l.delete!=null?(i.push({from:o,to:o+l.delete,insert:""}),o+=l.delete):o+=l.retain}t.dispatch({changes:i,annotations:[Tn.of(this.conf)]})}},this._ytext=this.conf.ytext,this._ytext.observe(this._observer)}update(t){if(!t.docChanged||t.transactions.length>0&&t.transactions[0].annotation(Tn)===this.conf)return;let e=this.conf.ytext;e.doc.transact(()=>{let r=0;t.changes.iterChanges((s,i,o,c,l)=>{let a=l.sliceString(0,l.length,`
`);s!==i&&e.delete(s+r,i-s),a.length>0&&e.insert(s+r,a),r+=a.length-(i-s)})},this.conf)}destroy(){this._ytext.unobserve(this._observer)}},oo=io.ViewPlugin.fromClass(Gr);var j=kt(require("@codemirror/view"),1),Vn=kt(require("@codemirror/state"),1);var co=j.EditorView.baseTheme({".cm-ySelection":{},".cm-yLineSelection":{padding:0,margin:"0px 2px 0px 4px"},".cm-ySelectionCaret":{position:"relative",borderLeft:"1px solid black",borderRight:"1px solid black",marginLeft:"-1px",marginRight:"-1px",boxSizing:"border-box",display:"inline"},".cm-ySelectionCaretDot":{borderRadius:"50%",position:"absolute",width:".4em",height:".4em",top:"-.2em",left:"-.2em",backgroundColor:"inherit",transition:"transform .3s ease-in-out",boxSizing:"border-box"},".cm-ySelectionCaret:hover > .cm-ySelectionCaretDot":{transformOrigin:"bottom center",transform:"scale(0)"},".cm-ySelectionInfo":{position:"absolute",top:"-1.05em",left:"-1px",fontSize:".75em",fontFamily:"serif",fontStyle:"normal",fontWeight:"normal",lineHeight:"normal",userSelect:"none",color:"white",paddingLeft:"2px",paddingRight:"2px",zIndex:101,transition:"opacity .3s ease-in-out",backgroundColor:"inherit",opacity:0,transitionDelay:"0s",whiteSpace:"nowrap"},".cm-ySelectionCaret:hover > .cm-ySelectionInfo":{opacity:1,transitionDelay:"0s"}}),Pl=Vn.Annotation.define(),Jr=class extends j.WidgetType{constructor(t,e){super(),this.color=t,this.name=e}toDOM(){return xe("span",[L("class","cm-ySelectionCaret"),L("style",`background-color: ${this.color}; border-color: ${this.color}`)],[Wt("\u2060"),xe("div",[L("class","cm-ySelectionCaretDot")]),Wt("\u2060"),xe("div",[L("class","cm-ySelectionInfo")],[Wt(this.name)]),Wt("\u2060")])}eq(t){return t.color===this.color}compare(t){return t.color===this.color}updateDOM(){return!1}get estimatedHeight(){return-1}ignoreEvent(){return!0}},qr=class{constructor(t){this.conf=t.state.facet(Nt),this._listener=({added:e,updated:r,removed:s},i,o)=>{e.concat(r).concat(s).findIndex(l=>l!==this.conf.awareness.doc.clientID)>=0&&t.dispatch({annotations:[Pl.of([])]})},this._awareness=this.conf.awareness,this._awareness.on("change",this._listener),this.decorations=Vn.RangeSet.of([])}destroy(){this._awareness.off("change",this._listener)}update(t){let e=this.conf.ytext,r=e.doc,s=this.conf.awareness,i=[],o=this.conf.awareness.getLocalState();if(o!=null){let c=t.view.hasFocus&&t.view.dom.ownerDocument.hasFocus(),l=c?t.state.selection.main:null,a=o.cursor==null?null:St(o.cursor.anchor),h=o.cursor==null?null:St(o.cursor.head);if(l!=null){let u=Le(e,l.anchor),d=Le(e,l.head);(o.cursor==null||!Lr(a,u)||!Lr(h,d))&&s.setLocalStateField("cursor",{anchor:u,head:d})}else o.cursor!=null&&c&&s.setLocalStateField("cursor",null)}s.getStates().forEach((c,l)=>{if(l===s.doc.clientID)return;let a=c.cursor;if(a==null||a.anchor==null||a.head==null)return;let h=Oe(a.anchor,r),u=Oe(a.head,r);if(h==null||u==null||h.type!==e||u.type!==e)return;let{color:d="#30bced",name:f="Anonymous"}=c.user||{},g=c.user&&c.user.colorLight||d+"33",b=ht(h.index,u.index),p=q(h.index,u.index),y=t.view.state.doc.lineAt(b),v=t.view.state.doc.lineAt(p);if(y.number===v.number)i.push({from:b,to:p,value:j.Decoration.mark({attributes:{style:`background-color: ${g}`},class:"cm-ySelection"})});else{i.push({from:b,to:y.from+y.length,value:j.Decoration.mark({attributes:{style:`background-color: ${g}`},class:"cm-ySelection"})}),i.push({from:v.from,to:p,value:j.Decoration.mark({attributes:{style:`background-color: ${g}`},class:"cm-ySelection"})});for(let Bt=y.number+1;Bt<v.number;Bt++){let Kr=t.view.state.doc.line(Bt).from;i.push({from:Kr,to:Kr,value:j.Decoration.line({attributes:{style:`background-color: ${g}`,class:"cm-yLineSelection"}})})}}i.push({from:u.index,to:u.index,value:j.Decoration.widget({side:u.index-h.index>0?-1:1,block:!1,widget:new Jr(d,f)})})}),this.decorations=j.Decoration.set(i,!0)}},lo=j.ViewPlugin.fromClass(qr,{decorations:n=>n.decorations});var Mn=kt(require("@codemirror/state"),1),Ln=kt(require("@codemirror/view"),1);var ao=()=>{let n=!0;return(t,e)=>{if(n){n=!1;try{t()}finally{n=!0}}else e!==void 0&&e()}};var vn=class{constructor(t){this.undoManager=t}addTrackedOrigin(t){this.undoManager.addTrackedOrigin(t)}removeTrackedOrigin(t){this.undoManager.removeTrackedOrigin(t)}undo(){return this.undoManager.undo()!=null}redo(){return this.undoManager.redo()!=null}},Be=Mn.Facet.define({combine(n){return n[n.length-1]}}),Oa=Mn.Annotation.define(),Wr=class{constructor(t){this.view=t,this.conf=t.state.facet(Be),this._undoManager=this.conf.undoManager,this.syncConf=t.state.facet(Nt),this._beforeChangeSelection=null,this._mux=ao(),this._onStackItemAdded=({stackItem:e,changedParentTypes:r})=>{r.has(this.syncConf.ytext)&&this._beforeChangeSelection&&!e.meta.has(this)&&e.meta.set(this,this._beforeChangeSelection)},this._onStackItemPopped=({stackItem:e})=>{let r=e.meta.get(this);if(r){let s=this.syncConf.fromYRange(r);t.dispatch(t.state.update({selection:s,effects:[Ln.EditorView.scrollIntoView(s)]})),this._storeSelection()}},this._storeSelection=()=>{this._beforeChangeSelection=this.syncConf.toYRange(this.view.state.selection.main)},this._undoManager.on("stack-item-added",this._onStackItemAdded),this._undoManager.on("stack-item-popped",this._onStackItemPopped),this._undoManager.addTrackedOrigin(this.syncConf)}update(t){t.selectionSet&&(t.transactions.length===0||t.transactions[0].annotation(Tn)!==this.syncConf)&&this._storeSelection()}destroy(){this._undoManager.off("stack-item-added",this._onStackItemAdded),this._undoManager.off("stack-item-popped",this._onStackItemPopped),this._undoManager.removeTrackedOrigin(this.syncConf)}},ho=Ln.ViewPlugin.fromClass(Wr),uo=({state:n,dispatch:t})=>n.facet(Be).undo()||!0,fo=({state:n,dispatch:t})=>n.facet(Be).redo()||!0;var po=(n,t,{undoManager:e=new ee(n)}={})=>{let r=new In(n,t),s=[Nt.of(r),oo];return t&&s.push(co,lo),e!==!1&&s.push(Be.of(new vn(e)),ho,go.EditorView.domEventHandlers({beforeinput(i,o){return i.inputType==="historyUndo"?uo(o):i.inputType==="historyRedo"?fo(o):!1}})),s};var On=class{constructor(t,e,r){this.editorView=t;this.ytext=e;this.provider=r}bind(){this.collabExtension=po(this.ytext,this.provider.awareness,{undoManager:!1}),this.editorView.dispatch({effects:mo.StateEffect.appendConfig.of(this.collabExtension)})}unbind(){this.collabExtension&&(this.collabExtension=null)}};var Nn=class{constructor(t,e){this.plugin=t;this.syncManager=e;this.currentBinding=null;this.currentFile=null}register(){this.plugin.registerEvent(this.plugin.app.workspace.on("active-leaf-change",t=>{this.handleLeafChange(t)}))}async handleLeafChange(t){if(this.currentBinding&&(this.currentBinding.unbind(),this.currentBinding=null),this.currentFile&&(this.syncManager.destroySession(this.currentFile),this.currentFile=null),!t)return;let e=t.view;if(!(e instanceof wo.MarkdownView))return;let r=e.file;if(!r)return;let s=this.getEditorView(e);s&&await this.startSync(r,s)}async startSync(t,e){try{let r=await this.syncManager.createSession(t);this.currentBinding=new On(e,r.ytext,r.provider),this.currentBinding.bind(),this.currentFile=t,this.plugin.updateStatus("connected")}catch(r){console.error("Failed to start sync:",r),this.plugin.updateStatus("error")}}getEditorView(t){return t.editor.cm}};var ue=require("obsidian"),Bn=class extends ue.PluginSettingTab{constructor(e,r){super(e,r);this.plugin=r}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Team Sync Settings"}),new ue.Setting(e).setName("Server URL").setDesc("WebSocket URL of the sync server (e.g., ws://localhost:1234)").addText(r=>r.setPlaceholder("ws://localhost:1234").setValue(this.plugin.settings.serverUrl).onChange(async s=>{this.plugin.settings.serverUrl=s,await this.plugin.saveSettings()})),new ue.Setting(e).setName("Username").setDesc("Display name shown to other users (for cursor awareness)").addText(r=>r.setPlaceholder("Anonymous").setValue(this.plugin.settings.username).onChange(async s=>{this.plugin.settings.username=s,await this.plugin.saveSettings()})),new ue.Setting(e).setName("Enable sync").setDesc("Turn collaborative sync on or off").addToggle(r=>r.setValue(this.plugin.settings.enabled).onChange(async s=>{this.plugin.settings.enabled=s,await this.plugin.saveSettings(),s?(this.plugin.editorMonitor.register(),this.plugin.updateStatus("connected")):(this.plugin.syncManager.destroyAll(),this.plugin.updateStatus("disconnected"))}))}};var Rn=class extends yo.Plugin{async onload(){await this.loadSettings(),this.syncManager=new Dn(this.app,this.settings.serverUrl,this.settings.username),this.editorMonitor=new Nn(this,this.syncManager),this.settings.enabled&&this.editorMonitor.register(),this.statusBarItem=this.addStatusBarItem(),this.updateStatus("disconnected"),this.addSettingTab(new Bn(this.app,this)),this.addCommand({id:"toggle-sync",name:"Toggle sync on/off",callback:()=>{this.settings.enabled=!this.settings.enabled,this.saveSettings(),this.settings.enabled?(this.editorMonitor.register(),this.updateStatus("connected")):(this.syncManager.destroyAll(),this.updateStatus("disconnected"))}})}onunload(){this.syncManager.destroyAll()}async loadSettings(){this.settings=Object.assign({},Qr,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}updateStatus(e){let r={connected:"\u{1F7E2}",disconnected:"\u26AA",syncing:"\u{1F7E1}",error:"\u{1F534}"},s={connected:"Sync: Connected",disconnected:"Sync: Off",syncing:"Sync: Syncing",error:"Sync: Error"};this.statusBarItem.setText(`${r[e]} ${s[e]}`)}};
